<!DOCTYPE html>
<html lang="zh-tw">
<head><meta name="generator" content="Hexo 3.9.0">

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<meta name="author" content="Tomas Lin">


    
    


<meta property="og:type" content="website">
<meta property="og:title" content="湯瑪士的部落格">
<meta property="og:url" content="https://horsekitlin.github.io/page/9/index.html">
<meta property="og:site_name" content="湯瑪士的部落格">
<meta property="og:locale" content="zh-tw">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="湯瑪士的部落格">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="湯瑪士的部落格" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">


    <style> .article { opacity: 0;} </style>


<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>湯瑪士的部落格</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: undefined
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Tomas Lin</a></h1>
        </hgroup>

        
        <p class="header-subtitle">技術手扎！不定期更新</p>
        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/archives/">主頁</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">標籤</a></li>
                        
                            <li><a href="/about/">關於我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:passon.com.tw@gmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="https://github.com/passontw" title="GitHub"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/BuckleScript/">BuckleScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Css/">Css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DesignPatten/">DesignPatten</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DevOps/">DevOps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FunctionPrograming/">FunctionPrograming</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IThome2018/">IThome2018</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IThome2023/">IThome2023</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javascript/">Javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kubernetes/">Kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Leetcode/">Leetcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Material-design/">Material-design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MessageQueue/">MessageQueue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Microservies/">Microservies</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nodejs/">Nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React-Native/">React Native</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Reason/">Reason</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redux/">Redux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SocketCluster/">SocketCluster</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sodility/">Sodility</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Themes/">Themes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Translate/">Translate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Truffle/">Truffle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Typescript/">Typescript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VSCode/">VSCode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ithome-12/">ithome 12</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-boot/">spring-boot</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于前端</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Tomas Lin</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Tomas Lin</a></h1>
            </hgroup>
            
            <p class="header-subtitle">技術手扎！不定期更新</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/archives/">主頁</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">標籤</a></li>
                
                    <li><a href="/about/">關於我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:passon.com.tw@gmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/passontw" title="GitHub"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap">
  
    <article id="post-RabbitMQ-Routing" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/27/RabbitMQ-Routing/" class="article-date">
      <time datetime="2017-05-27T09:29:41.000Z" itemprop="datePublished">2017-05-27</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/27/RabbitMQ-Routing/">RabbitMQ-Routing</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Routing"><a href="#Routing" class="headerlink" title="Routing"></a>Routing</h1><p>之前完成了 fanout 的 logging system</p>
<p>但是我們不希望每一則訊息都會通知到每一個人</p>
<p>也希望會有一些特定的訊息推送</p>
<p>這時就可以利用 direct 來做訊息的發送</p>
<p>可是 direct 並沒有辦法做到多個條件分類 Route</p>
<p>因為不希望 logging system 只能依據嚴重性來發送訊息</p>
<p>例如 unix 中的 syslog 中就可以依據嚴重性或是設備其他條件來發訊息傳遞</p>
<p>會更加彈性化</p>
<p>此時為了要達到這個需要</p>
<p>必須使用較為複雜的 <strong>topic exchange</strong></p>
<h2 id="Topic-Exchange"><a href="#Topic-Exchange" class="headerlink" title="Topic Exchange"></a>Topic Exchange</h2><p>當訊息發送到 topic exchage 的時候 <em>route_key</em> 是由多個字使用 <strong>.</strong> 來做分隔組成</p>
<p>這些字也不是隨意選定</p>
<p>通常都代表著 features </p>
<p>Example:</p>
<ul>
<li>“stock.usd.nyse”</li>
<li>“nyse.vmw”</li>
<li>“quick.orange.rabbit”.</li>
</ul>
<p>上述都是可以當成 Routing 的範例</p>
<p>最多可以接受 255 bytes 的大小</p>
<p>### Binding Key</p>
<p>可以有兩種特別的綁定方式</p>
<p><em> ‘</em>‘ (star) 可以取代一個字</p>
<ul>
<li>‘#’ (hash) 可以取代零或多個字</li>
</ul>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><p>範例中我們發送關於描述動物的訊息</p>
<p>訊息將會以三個字(兩個.)的方式來發送</p>
<p>第一個字描述速度</p>
<p>第二個字描述描述顏色</p>
<p>第三個描述種類</p>
<p>建立建立三種不同的 Binding key</p>
<ol>
<li>“<em>.orange.</em>“ //所有橘色的動物</li>
<li>“<em>.</em>.rabbit” // 所有兔子類的動物</li>
<li>“lazy.#” // 所有 lazy 的動物</li>
</ol>
<p>若發送一個 “quick.orange.rabbit” 會發送給兩個 Queue</p>
<p>“lazy.orange.elephone” 也會發送給兩個 Queue</p>
<p>“quick.orange.fox” 只會發送給一個 Queue</p>
<p>“quick.brown.fox” 則不會發送給任何 Queue 而被棄用</p>
<p>若我們發送單一字節 如”Orange” </p>
<p>這些都不會符合 binding routing</p>
<p>發送四個字節 “quick.orange.male.rabbit”</p>
<p>因為最後一個字節有符合</p>
<p>將會被傳到第二個 Queue</p>
<p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Topic  Exchange</span><br><span class="line"></span><br><span class="line">Topic Exchange 是相當強大的 Exchange</span><br><span class="line"></span><br><span class="line">而且可以模仿其他不同的 Exchange</span><br><span class="line"></span><br><span class="line">如果有你使用 <span class="string">"#"</span> 則可以取得所有 Exchange </span><br><span class="line"></span><br><span class="line">效果就如同 fanout</span><br><span class="line"></span><br><span class="line">若是沒有使用 <span class="string">"*"</span>, <span class="string">"#"</span> 來做 Routing</span><br><span class="line"></span><br><span class="line">效果則是如同 direct一樣</span><br><span class="line"></span><br><span class="line"><span class="comment">## Putting it all together</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### emit_log_topic.js</span></span><br><span class="line"></span><br><span class="line">```js</span><br><span class="line"><span class="keyword">const</span> amqp = <span class="keyword">require</span>(<span class="string">'amqplib/callback_api'</span>);</span><br><span class="line"></span><br><span class="line">amqp.connect(<span class="string">'amqp:localhost'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err, conn)</span> </span>&#123;</span><br><span class="line">  conn.createChannel(<span class="function"><span class="keyword">function</span> <span class="params">(err, ch)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> ex = <span class="string">'topic_logs'</span>;</span><br><span class="line">    <span class="keyword">const</span> args = process.argv.slice(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">const</span> key = (args.length &gt; <span class="number">0</span>) ? args[<span class="number">0</span>] : <span class="string">'anonymous.info'</span>;</span><br><span class="line">    <span class="keyword">const</span> msg = args.slice(<span class="number">1</span>).join(<span class="string">' '</span>) || <span class="string">'Hello World'</span>;</span><br><span class="line"></span><br><span class="line">    ch.assertExchange(ex, <span class="string">'topic'</span>, &#123; durable: <span class="keyword">false</span> &#125;);</span><br><span class="line">    ch.publish(ex, key, <span class="keyword">new</span> Buffer(msg));</span><br><span class="line">    console.log(<span class="string">" [x] Sent %s:'%s'"</span>, key, msg);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123; conn.close(); process.<span class="keyword">exit</span>(<span class="number">0</span>) &#125;, <span class="number">500</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="receive-logs-topic-js"><a href="#receive-logs-topic-js" class="headerlink" title="receive_logs_topic.js"></a>receive_logs_topic.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> amqp = <span class="built_in">require</span>(<span class="string">'amqplib/callback_api'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> args = process.argv.slice(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (args.length === <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Usage: receive_logs_topic.js &lt;facility&gt;.&lt;severity&gt;"</span>);</span><br><span class="line">  process.exit(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">amqp.connect(<span class="string">'amqp://localhost'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, conn</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">  conn.createChannel(<span class="function"><span class="keyword">function</span> (<span class="params">err, ch</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> ex = <span class="string">'topic_logs'</span>;</span><br><span class="line"></span><br><span class="line">    ch.assertExchange(ex, <span class="string">'topic'</span>, &#123; <span class="attr">durable</span>: <span class="literal">false</span> &#125;);</span><br><span class="line"></span><br><span class="line">    ch.assertQueue(<span class="string">''</span>, &#123; <span class="attr">exclusive</span>: <span class="literal">true</span> &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, q</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">' [*] Waiting for logs. To exit press CTRL+C'</span>);</span><br><span class="line"></span><br><span class="line">      args.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">key</span>) </span>&#123;</span><br><span class="line">        ch.bindQueue(q.queue, ex, key);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      ch.consume(q.queue, <span class="function"><span class="keyword">function</span> (<span class="params">msg</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">" [x] %s:'%s'"</span>, msg.fields.routingKey, msg.content.toString());</span><br><span class="line">      &#125;, &#123; <span class="attr">noAck</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/RabbitMQ/">RabbitMQ</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MessageQueue/">MessageQueue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nodejs/">Nodejs</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-RabbitMQ-PublishAndSubscribe" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/26/RabbitMQ-PublishAndSubscribe/" class="article-date">
      <time datetime="2017-05-25T16:00:15.000Z" itemprop="datePublished">2017-05-26</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/26/RabbitMQ-PublishAndSubscribe/">RabbitMQ-PublishAndSubscribe</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Publish-and-Subscribe"><a href="#Publish-and-Subscribe" class="headerlink" title="Publish and Subscribe"></a>Publish and Subscribe</h1><p>為了說明發布與訂閱</p>
<p>我們將會建立一個簡單的 log system</p>
<p>這包含了兩隻程式</p>
<p>一隻會發布 log</p>
<p>另一隻則會接收並且 print 在 console上</p>
<p>若我們有多個接收的程式</p>
<p>他們就都會接收到同樣的訊息</p>
<p>如此的話</p>
<p>我們就可以一個程式在接收到 Log 後寫入檔案</p>
<p>另一個接收到 Log 則將訊息顯示在螢幕上</p>
<p>也就是說也就是說發布的訊息將會被所有接收者接收</p>
<h2 id="Exchanges"><a href="#Exchanges" class="headerlink" title="Exchanges"></a>Exchanges</h2><p>我們之前教學的內容</p>
<ul>
<li>生產者負責發送訊息</li>
<li>Queue 是任務的暫存區</li>
<li>客戶是負責接收訊息</li>
</ul>
<p>RabbitMQ 的核心是生產者不直接發送任何訊息進入Queue</p>
<p>甚至也不知道 Message 發送後會進入哪一個Queue</p>
<p>生產者只需要將 Message 發送給 Exchange 就好了</p>
<p>Exchange 必須十分清楚接收到了訊息之後要如何處理</p>
<p>加入特定的 Queue?</p>
<p>加到多個 Queue?</p>
<p>或是應該捨棄</p>
<p>規則則由 Exchange type 定義</p>
<p>有幾種 Exchange type 可以使用</p>
<ul>
<li>Direct</li>
<li>Topic</li>
<li>headers</li>
<li>fanout</li>
</ul>
<p>這個範例是以 fanout 為主</p>
<p>先建立一個 fanout 類型的 type 命名為 log</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch.assertExchange(<span class="string">'logs'</span>, <span class="string">'fanout'</span>, &#123;<span class="attr">durable</span>: <span class="literal">false</span>&#125;);</span><br></pre></td></tr></table></figure>
<p>fanout 主要就是廣播給所有的 channel 知道</p>
<p>很適合這次的 Log 範例</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Listing exchanges</span></span><br><span class="line"></span><br><span class="line">列出可以使用的 Exchange <span class="class"><span class="keyword">type</span> 可以使用命令列查詢</span></span><br><span class="line"></span><br><span class="line">  $ sudo rabbitmqctl list_exchanges</span><br><span class="line"></span><br><span class="line">列表會顯示 amq.*</span><br><span class="line"></span><br><span class="line">發送預設的 Exchange</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch.sendToQueue(<span class="string">'hello'</span>, <span class="keyword">new</span> Buffer(<span class="string">'Hello World!'</span>));</span><br></pre></td></tr></table></figure>
<p>我們發送一個 訊息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch.publish(<span class="string">'logs'</span>, <span class="string">''</span>, <span class="keyword">new</span> Buffer(<span class="string">'Hello World!'</span>));</span><br></pre></td></tr></table></figure>
<p>第二個值給空字串代表我們沒有要發送給其他 chaneel, 只有要發送給 log</p>
<h3 id="Temporary-queues"><a href="#Temporary-queues" class="headerlink" title="Temporary queues"></a>Temporary queues</h3><p>可以將 Queue 定義一個 name</p>
<p>而 producers 要與 consumers 要共享時</p>
<p>就可以依據 name 做為指定 Queue 的依據</p>
<p>而對於每一個 Queue 重視的是當前的訊息</p>
<p>對於已經取得過的訊息並不重視</p>
<p>所以我們在取得一個新的 Queue 時有兩個事情是很重要的</p>
<ol>
<li>初始化必須是空的一個 Queue</li>
<li>所有連結者斷線後，必須刪掉Queue</li>
</ol>
<h3 id="Binding"><a href="#Binding" class="headerlink" title="Binding"></a>Binding</h3><p>剛剛有建立了一個 fanout 的 channel 名為 log</p>
<p>現在我們希望告訴這個 log 有訊息的時候可以通知我</p>
<p>這個行為叫做 binding</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch.bindQueue(queue_name, <span class="string">'logs'</span>, <span class="string">''</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 可以列出目前有binding 的 queue list</span><br><span class="line"></span><br><span class="line">rabbitmqctl list_bindings</span><br></pre></td></tr></table></figure>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><h4 id="emeit-log-js"><a href="#emeit-log-js" class="headerlink" title="emeit_log.js"></a>emeit_log.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> amqp = <span class="built_in">require</span>(<span class="string">'amqplib/callback_api'</span>);</span><br><span class="line"></span><br><span class="line">amqp.connect(<span class="string">'amqp://localhost'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, conn</span>) </span>&#123;</span><br><span class="line">  conn.createChannel(<span class="function"><span class="keyword">function</span> (<span class="params">err, ch</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ex = <span class="string">'logs'</span>;</span><br><span class="line">    <span class="keyword">var</span> msg = process.argv.slice(<span class="number">2</span>).join(<span class="string">' '</span>) || <span class="string">'Hello World!'</span>;</span><br><span class="line"></span><br><span class="line">    ch.assertExchange(ex, <span class="string">'fanout'</span>, &#123; <span class="attr">durable</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    ch.publish(ex, <span class="string">''</span>, <span class="keyword">new</span> Buffer(msg));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">" [x] Sent %s"</span>, msg);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; conn.close(); process.exit(<span class="number">0</span>) &#125;, <span class="number">500</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="recive-log-js"><a href="#recive-log-js" class="headerlink" title="recive_log.js"></a>recive_log.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> amqp = <span class="built_in">require</span>(<span class="string">'amqplib/callback_api'</span>);</span><br><span class="line"></span><br><span class="line">amqp.connect(<span class="string">'amqp://localhost'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, conn</span>) </span>&#123;</span><br><span class="line">  conn.createChannel(<span class="function"><span class="keyword">function</span> (<span class="params">err, ch</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ex = <span class="string">'logs'</span>;</span><br><span class="line"></span><br><span class="line">    ch.assertExchange(ex, <span class="string">'fanout'</span>, &#123; <span class="attr">durable</span>: <span class="literal">false</span> &#125;);</span><br><span class="line"></span><br><span class="line">    ch.assertQueue(<span class="string">''</span>, &#123; <span class="attr">exclusive</span>: <span class="literal">true</span> &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, q</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">" [*] Waiting for messages in %s. To exit press CTRL+C"</span>, q.queue);</span><br><span class="line">      ch.bindQueue(q.queue, ex, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">      ch.consume(q.queue, <span class="function"><span class="keyword">function</span> (<span class="params">msg</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">" [x] %s"</span>, msg.content.toString());</span><br><span class="line">      &#125;, &#123; <span class="attr">noAck</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/RabbitMQ/">RabbitMQ</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MessageQueue/">MessageQueue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nodejs/">Nodejs</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-RabbitMQ-WorkQueue" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/24/RabbitMQ-WorkQueue/" class="article-date">
      <time datetime="2017-05-24T11:48:37.000Z" itemprop="datePublished">2017-05-24</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/24/RabbitMQ-WorkQueue/">RabbitMQ-WorkQueue</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Work-Queues"><a href="#Work-Queues" class="headerlink" title="Work Queues"></a>Work Queues</h1><p>避免一些佔用大量資源或是時間的工作，</p>
<p>我們幫每份工作定義一個 channel</p>
<p>透過 MessageQueue 發送文字訊息</p>
<p>通知增加一個 Task </p>
<p>而 Queue 會自動在未來某個時間點處理這件事情</p>
<h3 id="Round-robin-dispatching"><a href="#Round-robin-dispatching" class="headerlink" title="Round-robin dispatching"></a>Round-robin dispatching</h3><p>使用任務隊列的優點之一是能夠輕鬆地併行工作</p>
<p>如果我們正在建立許多的的工作</p>
<p>我們可以增加更多的worker</p>
<p>這樣可以輕易地擴充架構</p>
<h4 id="範例"><a href="#範例" class="headerlink" title="範例"></a>範例</h4><p>下列的範例可以開三個 Terminal console</p>
<p>兩個執行 work.js</p>
<p>而一個執行 new_task.js</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># shell 1</span></span><br><span class="line">  $ <span class="keyword">node</span> <span class="title">worker</span>.js</span><br></pre></td></tr></table></figure>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">node</span> <span class="title">worker</span>.js</span><br></pre></td></tr></table></figure>
<p>在第三個我們將發布新的任務</p>
<p>一旦您開始使用消費者</p>
<p>您可以發布一些消息</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># shell 3</span></span><br><span class="line">./<span class="keyword">new</span><span class="type">_task</span>.js First message.</span><br><span class="line">./<span class="keyword">new</span><span class="type">_task</span>.js Second message..</span><br><span class="line">./<span class="keyword">new</span><span class="type">_task</span>.js Third message...</span><br><span class="line">./<span class="keyword">new</span><span class="type">_task</span>.js Fourth message....</span><br><span class="line">./<span class="keyword">new</span><span class="type">_task</span>.js Fifth message.....</span><br></pre></td></tr></table></figure>
<p>執行結果</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># shell 1</span></span><br><span class="line">./worker.js</span><br><span class="line"><span class="meta"># =&gt; [*] Waiting for messages. To exit press CTRL+C</span></span><br><span class="line"><span class="meta"># =&gt; [x] Received 'First message.'</span></span><br><span class="line"><span class="meta"># =&gt; [x] Received 'Third message...'</span></span><br><span class="line"><span class="meta"># =&gt; [x] Received 'Fifth message.....'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># shell 2</span></span><br><span class="line">./worker.js</span><br><span class="line"><span class="meta"># =&gt; [*] Waiting for messages. To exit press CTRL+C</span></span><br><span class="line"><span class="meta"># =&gt; [x] Received 'Second message..'</span></span><br><span class="line"><span class="meta"># =&gt; [x] Received 'Fourth message....'</span></span><br></pre></td></tr></table></figure>
<h2 id="Message-acknowledgment"><a href="#Message-acknowledgment" class="headerlink" title="Message acknowledgment"></a>Message acknowledgment</h2><p>如果有一個長時間的任務</p>
<p>在執行過程中 crash</p>
<p>我們將會失去這個執行的任務</p>
<p>但是我們不希望失去任務</p>
<p>所以我們可以把任務交給其他的 <strong>worker</strong></p>
<p>為了確保任務不會消失</p>
<p>所以提供了 <strong>Message acknowledgment (消息確認)</strong></p>
<p>若是 worker Crash 連接關閉或 TCP 連接結束</p>
<p>並不發送確認訊息</p>
<p><strong>RabbitMQ</strong> 將會重新排隊</p>
<p>若有其他 worker 則會將任務轉給其他 worker</p>
<p>所以即使有長時間執行的任務</p>
<p>也會確保該任務執行完成不會丟失</p>
<p>在上一個例子中</p>
<p>消息確認功能被關閉</p>
<p><strong> {noAck: false} </strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ch.consume(q, <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> secs = msg.content.toString().split(<span class="string">'.'</span>).length - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">" [x] Received %s"</span>, msg.content.toString());</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">" [x] Done"</span>);</span><br><span class="line">    ch.ack(msg);</span><br><span class="line">  &#125;, secs * <span class="number">1000</span>);</span><br><span class="line">&#125;, &#123;<span class="attr">noAck</span>: <span class="literal">false</span>&#125;);</span><br></pre></td></tr></table></figure>
<p>上述範例可以確認任務會執行</p>
<p>若 worker Crash 也會把任務重新執行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">忘記確認</span><br><span class="line"></span><br><span class="line">錯過這個錯誤是一個常見的錯誤</span><br><span class="line"></span><br><span class="line">這是一個容易的錯誤</span><br><span class="line"></span><br><span class="line">但後果是嚴重的</span><br><span class="line"></span><br><span class="line">當您的客戶端退出（可能看起來像隨機重新傳遞）時</span><br><span class="line"></span><br><span class="line">消息將被重新傳遞</span><br><span class="line"></span><br><span class="line">但是RabbitMQ將會消耗越來越多的內存</span><br><span class="line"></span><br><span class="line">因為它將無法釋放任何未包含的消息</span><br></pre></td></tr></table></figure>
<h2 id="Message-durability"><a href="#Message-durability" class="headerlink" title="Message durability"></a>Message durability</h2><p>我們已經學會瞭如何確保即使 worker Crash</p>
<p>任務也不會丟失</p>
<p>但是如果RabbitMQ服務器停止</p>
<p>我們的任務仍然會丟失</p>
<p>當RabbitMQ退出或崩潰時</p>
<p>它會忘記隊列和消息</p>
<p>需要兩件事來確保消息不會丟失：我們需要將 <strong>Queue</strong> 和消息 durable 設定為 true</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch.assertQueue(<span class="string">'hello'</span>, &#123;<span class="string">durable:</span> <span class="literal">true</span>&#125;);</span><br></pre></td></tr></table></figure>
<p>雖然這個命令本身是正確的</p>
<p>但是在我們目前的設置中是不行的</p>
<p>這是因為我們已經定義了一個不耐用的名為 <strong>hello</strong> 的隊列。</p>
<p><strong>RabbitMQ</strong> 不允許您重新定義具有不同參數的現有隊列</p>
<p>並會向嘗試執行此操作的任何程序返回錯誤</p>
<p>但是有一個快速的解決方法 - 讓我們用不同的名稱聲明一個隊列</p>
<p>例如task_queue</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch.assertQueue(<span class="string">'task_queue'</span>, &#123;<span class="string">durable:</span> <span class="literal">true</span>&#125;);</span><br></pre></td></tr></table></figure>
<p>這種持久的選項更改需要適用於 <strong>new_task</strong> 和 <strong>worker</strong>代碼。</p>
<p>在這一點上 我們確信</p>
<p>即使RabbitMQ重新啟動</p>
<p><strong>task_queue</strong> Queue也不會丟失</p>
<p>現在我們需要使用持久化選項 <strong>Channel.sendToQueue</strong> 來將消息標記為持久性</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ch</span><span class="selector-class">.sendToQueue</span>(<span class="selector-tag">q</span>, <span class="selector-tag">new</span> <span class="selector-tag">Buffer</span>(<span class="selector-tag">msg</span>), &#123;<span class="attribute">persistent</span>: true&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">注意消息持久性</span><br><span class="line"></span><br><span class="line">將消息標記為持久性不能完全保證消息不會丟失</span><br><span class="line"></span><br><span class="line">雖然它告訴RabbitMQ將消息保存到硬碟</span><br><span class="line"></span><br><span class="line">但是當RabbitMQ接受消息並且還沒有保存時</span><br><span class="line"></span><br><span class="line">仍然有一個很短的時間窗口</span><br><span class="line"></span><br><span class="line">RabbitMQ不會對每個消息執行fsync（<span class="number">2</span>） - 它可能只是保存到緩存中</span><br><span class="line"></span><br><span class="line">而不是真正寫入磁盤</span><br><span class="line"></span><br><span class="line">持久性保證不強</span><br><span class="line"></span><br><span class="line">但對我們的簡單任務隊列來說已經足夠了</span><br><span class="line"></span><br><span class="line">如果您需要更強大的保證</span><br><span class="line"></span><br><span class="line">那麼您可以使用發布商確認</span><br></pre></td></tr></table></figure>
<h3 id="Fair-dispatch"><a href="#Fair-dispatch" class="headerlink" title="Fair dispatch"></a>Fair dispatch</h3><p>您可能已經注意到</p>
<p>dispatching 仍然無法正常工作</p>
<p>例如在兩個 <strong>worker</strong> 的情況下</p>
<p>當所有奇怪的信息都很消耗資源與時間</p>
<p>甚至信息很小的時候</p>
<p>一個<strong>worker</strong>將不斷忙碌</p>
<p>另一個<strong>worker</strong>幾乎不會做任何工作</p>
<p>那麼 <strong>RabbitMQ</strong> 還會平均分配消息</p>
<p>這是因為當消息進入隊列時</p>
<p><strong>RabbitMQ</strong>只會分派消息</p>
<p>它不看 <strong>sender</strong> 的未確認消息的數量</p>
<p>它只是盲目地向第n個 <strong>sender</strong> 發送每個第n個消息。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">ch</span><span class="number">.</span><span class="keyword">prefetch</span>(<span class="number">1</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">注意 <span class="built_in">Queue</span>大小</span><br><span class="line"></span><br><span class="line">如果所有的 **worker** 都忙</span><br><span class="line"></span><br><span class="line">你的<span class="built_in">Queue</span>可以填滿</span><br><span class="line"></span><br><span class="line">你會想要注意的是</span><br><span class="line"></span><br><span class="line">也許增加更多的 worker 或者有其他的策略</span><br></pre></td></tr></table></figure>
<h2 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> amqp = <span class="built_in">require</span>(<span class="string">'amqplib/callback_api'</span>);</span><br><span class="line"></span><br><span class="line">amqp.connect(<span class="string">'amqp://localhost'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, conn</span>) </span>&#123;</span><br><span class="line">  conn.createChannel(<span class="function"><span class="keyword">function</span> (<span class="params">err, ch</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> q = <span class="string">'task'</span>;</span><br><span class="line"></span><br><span class="line">    ch.assertQueue(q, &#123; <span class="attr">durable</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">" [*] Waiting for messages in %s. To exit press CTRL+C"</span>, q);</span><br><span class="line">    ch.consume(q, <span class="function"><span class="keyword">function</span> (<span class="params">msg</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> secs = msg.content.toString().split(<span class="string">'.'</span>).length - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">" [x] Received %s"</span>, msg.content.toString());</span><br><span class="line">      setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">" [x] Done"</span>);</span><br><span class="line">        ch.ack(msg);</span><br><span class="line">      &#125;, secs * <span class="number">1000</span>);</span><br><span class="line">    &#125;, &#123; <span class="attr">noAck</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><p>new_task.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> amqp = <span class="built_in">require</span>(<span class="string">'amqplib/callback_api'</span>);</span><br><span class="line"></span><br><span class="line">amqp.connect(<span class="string">'amqp://localhost'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, conn</span>) </span>&#123;</span><br><span class="line">  conn.createChannel(<span class="function"><span class="keyword">function</span> (<span class="params">err, ch</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> q = <span class="string">'task'</span>;</span><br><span class="line">    <span class="keyword">const</span> msg = process.argv.slice(<span class="number">2</span>).join(<span class="string">' '</span>) || <span class="string">'Hello world!'</span>;</span><br><span class="line">    ch.assertQueue(q, &#123; <span class="attr">durable</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    ch.sendToQueue(q, <span class="keyword">new</span> Buffer(msg), &#123; <span class="attr">persistent</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">" [x] Sent '%s'"</span>, msg);</span><br><span class="line">  &#125;);</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; conn.close(); process.exit(<span class="number">0</span>) &#125;, <span class="number">500</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/RabbitMQ/">RabbitMQ</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MessageQueue/">MessageQueue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nodejs/">Nodejs</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-RabbitMQ-Install" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/22/RabbitMQ-Install/" class="article-date">
      <time datetime="2017-05-22T07:05:41.000Z" itemprop="datePublished">2017-05-22</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/22/RabbitMQ-Install/">RabbitMQ-Install</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Rabbit-Message-Queue"><a href="#Rabbit-Message-Queue" class="headerlink" title="Rabbit Message Queue"></a>Rabbit Message Queue</h1><h2 id="Installing-on-Homebrew"><a href="#Installing-on-Homebrew" class="headerlink" title="Installing on Homebrew"></a>Installing on Homebrew</h2><h3 id="Step-1"><a href="#Step-1" class="headerlink" title="Step 1"></a>Step 1</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">brew </span>update</span><br></pre></td></tr></table></figure>
<h3 id="Step-2"><a href="#Step-2" class="headerlink" title="Step 2"></a>Step 2</h3><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">brew </span><span class="keyword">install </span>rabbitmq</span><br></pre></td></tr></table></figure>
<h3 id="Step-3"><a href="#Step-3" class="headerlink" title="Step 3"></a>Step 3</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>rabbitmqctl status</span><br></pre></td></tr></table></figure>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><p>send.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> amqp = <span class="built_in">require</span>(<span class="string">'amqplib/callback_api'</span>);</span><br><span class="line"></span><br><span class="line">amqp.connect(<span class="string">'amqp://localhost'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, conn</span>) </span>&#123;</span><br><span class="line">  conn.createChannel(<span class="function">(<span class="params">err, ch</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> q = <span class="string">'hello'</span>;</span><br><span class="line">    <span class="keyword">const</span> msg = <span class="string">'Hello World!'</span>;</span><br><span class="line"></span><br><span class="line">    ch.assertQueue(q, &#123; <span class="attr">durable</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    ch.sendToQueue(q, <span class="keyword">new</span> Buffer(<span class="string">'Hello world'</span>));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">" [x] Sent 'Hello World!'"</span>);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; conn.close(); process.exit(<span class="number">0</span>) &#125;, <span class="number">500</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><p>receive.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> amqp = <span class="built_in">require</span>(<span class="string">'amqplib/callback_api'</span>);</span><br><span class="line"></span><br><span class="line">amqp.connect(<span class="string">'amqp://localhost'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, conn</span>) </span>&#123;</span><br><span class="line">  conn.createChannel(<span class="function">(<span class="params">err, ch</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> q = <span class="string">'hello'</span>;</span><br><span class="line">    <span class="keyword">const</span> msg = <span class="string">'Hello World!'</span>;</span><br><span class="line"></span><br><span class="line">    ch.assertQueue(q, &#123; <span class="attr">durable</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    ch.sendToQueue(q, <span class="keyword">new</span> Buffer(<span class="string">'Hello world'</span>));</span><br><span class="line">  </span><br><span class="line">  &#125;);</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; conn.close(); process.exit(<span class="number">0</span>) &#125;, <span class="number">500</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h3><p><img src="&#39;../images/rabitmq/rabbitmqdemo.png&#39;" alt="Demo Result"></p>
<h2 id="參考文章"><a href="#參考文章" class="headerlink" title="參考文章"></a>參考文章</h2><p><a href="https://www.rabbitmq.com/tutorials/tutorial-one-javascript.html" target="_blank" rel="noopener">install</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/RabbitMQ/">RabbitMQ</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MessageQueue/">MessageQueue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nodejs/">Nodejs</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Leetcode-Q6" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/09/Leetcode-Q6/" class="article-date">
      <time datetime="2017-05-09T11:34:15.000Z" itemprop="datePublished">2017-05-09</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/09/Leetcode-Q6/">Leetcode-Q6</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="12-Integer-to-Roman"><a href="#12-Integer-to-Roman" class="headerlink" title="12 Integer to Roman"></a>12 Integer to Roman</h1><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><p>Given an integer, convert it to a roman numeral.</p>
<p>Input is guaranteed to be within the range from 1 to 3999.</p>
<p>這是進制的轉換</p>
<p>要將十進位進位轉換成羅馬數字</p>
<p>數字的範圍在1~3999</p>
<p><a href="https://zh.wikipedia.org/zh-tw/%E7%BD%97%E9%A9%AC%E6%95%B0%E5%AD%97" target="_blank" rel="noopener">關於羅馬數字的規則</a></p>
<ul>
<li><p>羅馬數字總共會有七個 Ⅰ（1）、Ⅴ（5）、Ⅹ（10）、Ⅼ（50）、Ⅽ（100）、Ⅾ（500）和Ⅿ（1000）</p>
</li>
<li><p>重複數次：一個羅馬數字重複幾次，就表示這個數的幾倍</p>
</li>
</ul>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> intToRoman = <span class="function"><span class="keyword">function</span> (<span class="params">num</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (num &lt; <span class="number">1</span> || num &gt; <span class="number">3999</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> lookup = &#123; <span class="attr">M</span>: <span class="number">1000</span>, <span class="attr">CM</span>: <span class="number">900</span>, <span class="attr">D</span>: <span class="number">500</span>, <span class="attr">CD</span>: <span class="number">400</span>, <span class="attr">C</span>: <span class="number">100</span>, <span class="attr">XC</span>: <span class="number">90</span>, <span class="attr">L</span>: <span class="number">50</span>, <span class="attr">XL</span>: <span class="number">40</span>, <span class="attr">X</span>: <span class="number">10</span>, <span class="attr">IX</span>: <span class="number">9</span>, <span class="attr">V</span>: <span class="number">5</span>, <span class="attr">IV</span>: <span class="number">4</span>, <span class="attr">I</span>: <span class="number">1</span> &#125;;</span><br><span class="line">  <span class="keyword">let</span> romanStr = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> lookup) &#123;</span><br><span class="line">    <span class="keyword">while</span> (num &gt;= lookup[key]) &#123;</span><br><span class="line">      romanStr += key;</span><br><span class="line">      num -= lookup[key];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> romanStr;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>因為有規範在1~3999之間</p>
<p>所以先檢查 <strong>num</strong> 是否在這個區間</p>
<p>若不在的話則回傳空字串</p>
<p>先用一個物件將羅馬數字設為Key與十進位數字設為Value</p>
<p>準備等等做比對計算</p>
<p>然後使用一個迴圈依序對此物件中的各值去做轉換</p>
<p>在迴圈中加上一個 <strong>while</strong> 迴圈</p>
<p>當值比較大的時候</p>
<p>代表它可以在轉換一次</p>
<p>所以在romanStr中加上一次符號</p>
<p>num 在扣除相對的value</p>
<p>直到num為零為止</p>
<p>此時romanStr就是相對應的羅馬字串</p>
<p>回傳後就可以解答</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Leetcode/">Leetcode</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Leetcode/">Leetcode</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Leetcode-Q5" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/09/Leetcode-Q5/" class="article-date">
      <time datetime="2017-05-09T10:12:27.000Z" itemprop="datePublished">2017-05-09</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/09/Leetcode-Q5/">Leetcode-Q5</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="561-Array-Partition-I"><a href="#561-Array-Partition-I" class="headerlink" title="561 Array Partition I"></a>561 Array Partition I</h1><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><p>Given an array of 2n integers, your task is to group these integers into n pairs of integer, </p>
<p>say (a1, b1), (a2, b2), …, (an, bn) which makes sum of min(ai, bi) for all i from 1 to n as large as possible.</p>
<p>一個 <strong>2n</strong> 個整數的陣列</p>
<p>將這些整入分成N對整數<br> (a1, a2), (b1, b2)…..</p>
<p> 並使(ai, bi)的最大總和數</p>
<h2 id="Hint"><a href="#Hint" class="headerlink" title="Hint"></a>Hint</h2><p>將陣列做排序</p>
<p>然後切個 n 個陣列 每個陣列兩個元素</p>
<p>再把各自陣列的第二個元素相加</p>
<p>就可以得到答案</p>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nums = nums.sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> (a - b));</span><br><span class="line">  <span class="keyword">let</span> total = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; nums.length; index += <span class="number">2</span>) &#123;</span><br><span class="line">    total += nums[index];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> total;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Leetcode/">Leetcode</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Leetcode/">Leetcode</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Leetcode-Q4" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/07/Leetcode-Q4/" class="article-date">
      <time datetime="2017-05-07T12:43:56.000Z" itemprop="datePublished">2017-05-07</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/07/Leetcode-Q4/">Leetcode-Q4</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="9-Palindrome-Number"><a href="#9-Palindrome-Number" class="headerlink" title="9 Palindrome Number"></a>9 Palindrome Number</h1><h2 id="迴文數"><a href="#迴文數" class="headerlink" title="迴文數"></a>迴文數</h2><p><a href="https://zh.wikipedia.org/wiki/%E5%9B%9E%E6%96%87%E6%95%B0" target="_blank" rel="noopener">wiki</a></p>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> INT_MAX = <span class="number">2147483647</span>;</span><br><span class="line"><span class="keyword">let</span> y = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (x &gt; <span class="number">0</span> &amp;&amp; x &lt; <span class="number">10</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> str = x.toString(),</span><br><span class="line">    length = str.length,</span><br><span class="line">    total = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; length; index++) &#123;</span><br><span class="line">    <span class="keyword">let</span> num = <span class="built_in">parseInt</span>(str[index]) * <span class="built_in">Math</span>.pow(<span class="number">10</span>, index);</span><br><span class="line">    total += num;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (total &gt; INT_MAX</span><br><span class="line">    || total &lt; -(<span class="number">1</span> + INT_MAX)</span><br><span class="line">    || x &gt; INT_MAX</span><br><span class="line">    || x &lt; -(<span class="number">1</span> + INT_MAX)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (total === x) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這一題的原理跟上一題 <a href="&#39;./Leetcode-Q3.md&#39;">Reverse Integer</a> 原理類似</p>
<p>在翻轉變數之後</p>
<p>比對是否相等</p>
<p>若是相等就回傳 true</p>
<p>不相等就回傳 false</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Leetcode/">Leetcode</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Leetcode/">Leetcode</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Leetcode-Q3" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/06/Leetcode-Q3/" class="article-date">
      <time datetime="2017-05-06T10:03:56.000Z" itemprop="datePublished">2017-05-06</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/06/Leetcode-Q3/">Leetcode-Q3</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="7-Reverse-Integer"><a href="#7-Reverse-Integer" class="headerlink" title="7 Reverse Integer"></a>7 Reverse Integer</h1><h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><p>Example1: x = 123, return 321</p>
<p>Example2: x = -123, return -321</p>
<h2 id="解題"><a href="#解題" class="headerlink" title="解題"></a>解題</h2><h3 id="Version-1"><a href="#Version-1" class="headerlink" title="Version 1"></a>Version 1</h3><p>第一個想到的方式就是先用字串的方式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> reverse = <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> INT_MAX = <span class="number">2147483647</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> isNegativeNumber = (x &lt; <span class="number">0</span>) ? <span class="literal">true</span> : <span class="literal">false</span>,</span><br><span class="line">    y = <span class="built_in">Math</span>.abs(x).toString().split(<span class="string">''</span>)</span><br><span class="line">  length = y.length;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> result = [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">    result.push(y.pop());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> total = <span class="built_in">parseInt</span>(result.join(<span class="string">''</span>));</span><br><span class="line"></span><br><span class="line">  total = isNegativeNumber ? (<span class="number">0</span> - total) : total;</span><br><span class="line">  <span class="keyword">if</span> (total &gt; INT_MAX || total &lt; -(<span class="number">1</span> + INT_MAX)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> total;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我先確定他是否為負數</p>
<p>然後把數字轉絕對值 切一維陣列</p>
<p>在使用for 迴圈來迴轉</p>
<p>最後檢查是否有超出32 bit與回傳正負總值</p>
<p>但是這樣的效能實在欠佳</p>
<h3 id="Version-2"><a href="#Version-2" class="headerlink" title="Version 2"></a>Version 2</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> reverse = <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (x &gt;= <span class="number">0</span> &amp;&amp; x &lt; <span class="number">10</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> INT_MAX = <span class="number">2147483647</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> isNegativeNumber = (x &lt; <span class="number">0</span>) ? <span class="literal">true</span> : <span class="literal">false</span>,</span><br><span class="line">    y = <span class="built_in">Math</span>.abs(x).toString().split(<span class="string">''</span>),</span><br><span class="line">    length = y.length;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> total = <span class="number">0</span>;</span><br><span class="line">  y.map(<span class="function">(<span class="params">v, index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> value = <span class="built_in">parseInt</span>(v) * <span class="built_in">Math</span>.pow(<span class="number">10</span>, index);</span><br><span class="line">    total += value;</span><br><span class="line">  &#125;)</span><br><span class="line">  total = isNegativeNumber ? (<span class="number">0</span> - total) : total;</span><br><span class="line">  <span class="keyword">if</span> (total &gt; INT_MAX || total &lt; -(<span class="number">1</span> + INT_MAX)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> total;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>第二種方式其實跟第一種大同小異</p>
<p>只是我是利用數字十進位數的方式</p>
<p>使用迴圈加回去一個值</p>
<p>最後再檢查是否有超出32 bit</p>
<p>因為使用數字計算</p>
<p>所以效能提昇了不少</p>
<p>最高衝到了51 %</p>
<p>不過還是略有欠缺</p>
<p>若有其他解法再來更新</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Leetcode/">Leetcode</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Leetcode/">Leetcode</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Leetcode-Q2" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/05/Leetcode-Q2/" class="article-date">
      <time datetime="2017-05-04T16:12:49.000Z" itemprop="datePublished">2017-05-05</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/05/Leetcode-Q2/">Leetcode-Q2</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="1-Two-sum"><a href="#1-Two-sum" class="headerlink" title="1 Two sum"></a>1 Two sum</h1><h2 id="First-solution"><a href="#First-solution" class="headerlink" title="First solution"></a>First solution</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> twoSum = <span class="function"><span class="keyword">function</span>(<span class="params">nums, target</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> index,</span><br><span class="line">    index2 = <span class="number">-1</span>,</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(index === <span class="literal">undefined</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> num = nums[i],</span><br><span class="line">            need = target - num;</span><br><span class="line">        index2 = nums.indexOf(need)</span><br><span class="line">        <span class="keyword">if</span>(index2 === i)&#123;</span><br><span class="line">            index = <span class="literal">undefined</span>;</span><br><span class="line">            index2 = <span class="number">-1</span></span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(index2 !== <span class="number">-1</span>)&#123;</span><br><span class="line">            index = i;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [index, index2];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>因為是兩層的巢狀迴圈</p>
<p>加上有兩個 if 判斷式</p>
<p>所以效能會很差</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> twoSum = <span class="function"><span class="keyword">function</span>(<span class="params">nums, target</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> map = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span> ; i &lt; nums.length ; i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> v = nums[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> j = i+<span class="number">1</span> ; j &lt; nums.length ; j++ )&#123;</span><br><span class="line">            <span class="keyword">if</span>(  nums[i] + nums[j]  == target )&#123;</span><br><span class="line">                <span class="keyword">return</span> [i,j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>因為是兩層的巢狀迴圈</p>
<p>加上有一個 if 判斷式</p>
<p>所以效能好一點</p>
<p>但還是不理想</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> map = &#123;&#125;;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span> ; i &lt; nums.length ; i++)&#123;</span><br><span class="line">    <span class="keyword">var</span> v = nums[i];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(map[target-v] &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// 如果 target - v可以在map中找到值x，代表之前已經出現過值x， target = x + v</span></span><br><span class="line">        <span class="comment">// 因此回傳 x的位置與目前v的位置  </span></span><br><span class="line">        <span class="keyword">return</span> [map[target-v],i]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 使用map儲存目前的數字與其位置  </span></span><br><span class="line"></span><br><span class="line">        map[v] = i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>僅僅使用一層迴圈</p>
<p>若沒有找到的話就會記錄在 map 中</p>
<p>所以效能提升不少</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Leetcode/">Leetcode</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Leetcode/">Leetcode</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Leetcode-Q1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/03/Leetcode-Q1/" class="article-date">
      <time datetime="2017-05-03T13:24:46.000Z" itemprop="datePublished">2017-05-03</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/03/Leetcode-Q1/">Leetcode-Q1</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="538-Convert-BST-to-Greater-Tree"><a href="#538-Convert-BST-to-Greater-Tree" class="headerlink" title="538 Convert BST to Greater Tree"></a>538 Convert BST to Greater Tree</h1><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><p>Given a Binary Search Tree (BST), convert it to a Greater Tree such that every key of the original BST is changed to the original key plus sum of all keys greater than the original key in BST.</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">輸入一個<span class="keyword">Binary </span>Search Tree(<span class="keyword">BST), </span>將每一個節點得值更改為原始的值加上加上大於<span class="keyword">BST中 </span>Node 的值的總和</span><br></pre></td></tr></table></figure>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Input: The root of a Binary Search Tree like this:</span></span><br><span class="line">              <span class="number">5</span></span><br><span class="line">            <span class="string">/</span>   <span class="string">\</span></span><br><span class="line">           <span class="number">2</span>     <span class="number">13</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Output: The root of a Greater Tree like this:</span></span><br><span class="line">             <span class="number">18</span></span><br><span class="line">            <span class="string">/</span>   <span class="string">\</span></span><br><span class="line">          <span class="number">20</span>     <span class="number">13</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">var</span> convertBST = <span class="function"><span class="keyword">function</span>(<span class="params">root</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> vals = [];</span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">visit1</span>(<span class="params">root</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(root)&#123;</span><br><span class="line">          visit1(root.left);</span><br><span class="line">          vals.push(root.val);</span><br><span class="line">          visit1(root.right);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  visit1(root);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">visit2</span>(<span class="params">root</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(root)&#123;</span><br><span class="line">          visit2(root.right);</span><br><span class="line">          count += vals.pop();</span><br><span class="line">          root.val = count;</span><br><span class="line">          visit2(root.left);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  visit2(root);</span><br><span class="line">  <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h2><p>visit1: 利用遞迴將 Node 往下延伸到最左邊子元素的時候依序push 到陣列中</p>
<p>visit2: 利用遞迴將 Node 往下延伸到最右邊的子元素依序將 value 修改為加總得值</p>
<p>利用二元樹的特性來做輪巡並修改值</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Leetcode/">Leetcode</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Leetcode/">Leetcode</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/8/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/10/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2024 Tomas Lin
            </div>
            <!-- <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div> -->
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>