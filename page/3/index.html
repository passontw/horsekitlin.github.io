<!DOCTYPE html>
<html lang="zh-tw">
<head><meta name="generator" content="Hexo 3.9.0">

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<meta name="author" content="Tomas Lin">


    
    


<meta property="og:type" content="website">
<meta property="og:title" content="湯瑪士的部落格">
<meta property="og:url" content="https://horsekitlin.github.io/page/3/index.html">
<meta property="og:site_name" content="湯瑪士的部落格">
<meta property="og:locale" content="zh-tw">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="湯瑪士的部落格">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="湯瑪士的部落格" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">


    <style> .article { opacity: 0;} </style>


<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>湯瑪士的部落格</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: undefined
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Tomas Lin</a></h1>
        </hgroup>

        
        <p class="header-subtitle">技術手扎！不定期更新</p>
        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/archives/">主頁</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">標籤</a></li>
                        
                            <li><a href="/about/">關於我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:passon.com.tw@gmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="https://github.com/passontw" title="GitHub"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/BuckleScript/">BuckleScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Css/">Css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DesignPatten/">DesignPatten</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DevOps/">DevOps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FunctionPrograming/">FunctionPrograming</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IThome2018/">IThome2018</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IThome2023/">IThome2023</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javascript/">Javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kubernetes/">Kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Leetcode/">Leetcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Material-design/">Material-design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MessageQueue/">MessageQueue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Microservies/">Microservies</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nodejs/">Nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React-Native/">React Native</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Reason/">Reason</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redux/">Redux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SocketCluster/">SocketCluster</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sodility/">Sodility</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Themes/">Themes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Translate/">Translate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Truffle/">Truffle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Typescript/">Typescript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VSCode/">VSCode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ithome-12/">ithome 12</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-boot/">spring-boot</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于前端</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Tomas Lin</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Tomas Lin</a></h1>
            </hgroup>
            
            <p class="header-subtitle">技術手扎！不定期更新</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/archives/">主頁</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">標籤</a></li>
                
                    <li><a href="/about/">關於我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:passon.com.tw@gmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/passontw" title="GitHub"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap">
  
    <article id="post-React-Native-connect-server" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/09/15/React-Native-connect-server/" class="article-date">
      <time datetime="2020-09-14T16:56:00.000Z" itemprop="datePublished">2020-09-15</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/15/React-Native-connect-server/">React-Native-connect-server</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Initial-React-Native"><a href="#Initial-React-Native" class="headerlink" title="Initial React Native"></a>Initial React Native</h1><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npx react-<span class="keyword">native</span> <span class="keyword">init</span> imapp &amp;&amp; cd imapp</span><br></pre></td></tr></table></figure>
<h2 id="Run-on-ios"><a href="#Run-on-ios" class="headerlink" title="Run on ios"></a>Run on ios</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npx react-native-<span class="keyword">run</span><span class="bash">-ios</span></span><br></pre></td></tr></table></figure>
<h2 id="Install-SocketCluster-Client"><a href="#Install-SocketCluster-Client" class="headerlink" title="Install SocketCluster Client"></a>Install SocketCluster Client</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yarn <span class="keyword">add</span><span class="bash"> socketcluster-client</span></span><br></pre></td></tr></table></figure>
<h2 id="Initial-Socket"><a href="#Initial-Socket" class="headerlink" title="Initial Socket"></a>Initial Socket</h2><p>App.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> SocketClusterClient <span class="keyword">from</span> <span class="string">'socketcluster-client'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> socket = SocketClusterClient.create(&#123;</span><br><span class="line">  hostname: <span class="string">'localhost'</span>,</span><br><span class="line">  port: <span class="number">8000</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">socket.transmit(<span class="string">'foo'</span>, <span class="number">123</span>);</span><br></pre></td></tr></table></figure>
<p>Server 可以收到 <code>data</code></p>
<p>基本上已經可以確認接通了 SocketCluster Server 與 Client</p>
<p>之後就可以準備其他事情</p>
<h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><p><a href="https://github.com/SocketCluster/socketcluster-client" target="_blank" rel="noopener">socketcluster-Client</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/SocketCluster/">SocketCluster</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nodejs/">Nodejs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React-Native/">React Native</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SocketCluster/">SocketCluster</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ithome-12/">ithome 12</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Java-Spring-Boot-variable" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/09/11/Java-Spring-Boot-variable/" class="article-date">
      <time datetime="2020-09-11T06:42:52.000Z" itemprop="datePublished">2020-09-11</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/11/Java-Spring-Boot-variable/">Java-Spring-Boot-variable</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Spring-Boot"><a href="#Spring-Boot" class="headerlink" title="Spring Boot"></a>Spring Boot</h1><p>之前在 Java 已經處理了 <code>route</code>, <code>method</code> 的問題</p>
<p>接下來要處理使用 API 溝通時要傳遞參數的時候要如何實作？</p>
<ul>
<li>Path Variable</li>
<li>Query String Variable</li>
<li>Request Body Variable</li>
</ul>
<h2 id="Path-Variable"><a href="#Path-Variable" class="headerlink" title="Path Variable"></a>Path Variable</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.springbootdemo.web;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/books/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getOne</span><span class="params">(@PathVariable <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; book = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        book.put(<span class="string">"id"</span>, id);</span><br><span class="line">        book.put(<span class="string">"name"</span>, <span class="string">"new book"</span>);</span><br><span class="line">        book.put(<span class="string">"number"</span>, <span class="string">"123jkda"</span>);</span><br><span class="line">        <span class="keyword">return</span> book;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Java/">Java</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring-boot/">spring-boot</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Java-Spring-Boot-Initial" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/09/11/Java-Spring-Boot-Initial/" class="article-date">
      <time datetime="2020-09-11T05:46:59.000Z" itemprop="datePublished">2020-09-11</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/11/Java-Spring-Boot-Initial/">Java-Spring-Boot-Initial</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Initial-project-And-Hello-world"><a href="#Initial-project-And-Hello-world" class="headerlink" title="Initial project And Hello world"></a>Initial project And Hello world</h1><p><a href="https://www.jetbrains.com/idea/download/#section=mac" target="_blank" rel="noopener">download IntelliJ IDEA</a></p>
<p>建立一個新的 spring demo</p>
<p><img src="../../../../images/Java_Spring_Boot/initial-01.png" alt="Image"></p>
<p>安裝好之後可以建立一個新的 Controller</p>
<p>src -&gt; main -&gt; java -&gt; {packagename} -&gt; web -&gt; HelloController.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.springbootdemo.web;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"/say"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span>  String <span class="title">helloGET</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello World GET"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這樣就可以直接新增了一個 <code>http://loclahost:8081/api/say</code> 的 api</p>
<p><code>@RestController</code> 代表這是一個 Restful API class</p>
<p><code>@RequestMapping(&quot;route&quot;)</code> 來處理 url route 問題</p>
<ul>
<li>value: route</li>
<li>method: method [GET, POST, PUT, PATCH, DELETE]</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Java/">Java</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring-boot/">spring-boot</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-SocketCluster-Consumer" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/09/09/SocketCluster-Consumer/" class="article-date">
      <time datetime="2020-09-08T17:08:25.000Z" itemprop="datePublished">2020-09-09</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/09/SocketCluster-Consumer/">SocketCluster-Consumer</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Chennel"><a href="#Chennel" class="headerlink" title="Chennel"></a>Chennel</h1><p>之前有聊到 Chennel </p>
<p>但是當訊息量越來越大的時候</p>
<p>可以有一些機制來做傳遞與管理</p>
<p>在前端 Subscribe Channel </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> channel = socket.subscribe(<span class="string">"foo"</span>);</span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> data <span class="keyword">of</span> channel) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"forawait -&gt; data"</span>, data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>在多個前端可以 subscribe 同一個 channel </p>
<p>代表各個前端可以互相溝通</p>
<h1 id="Consumers"><a href="#Consumers" class="headerlink" title="Consumers"></a>Consumers</h1><p>SocketCluster 有多個函式可以針對 Channel 做控制</p>
<ul>
<li>socket.listener</li>
<li>socket.receiver</li>
<li>socket.procedure</li>
<li>socket.channel</li>
</ul>
<p>上述的 function 都會回傳 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for-await...of#Iterating_over_async_iterables" target="_blank" rel="noopener">async iterables</a></p>
<p>代表可以透過這個方式來取得 <code>data</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> &#123; socket &#125; <span class="keyword">of</span> agServer.listener(<span class="string">"connection"</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> data <span class="keyword">of</span> socket.receiver(<span class="string">'foo'</span>)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"forawait -&gt; data"</span>, data)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>這個可以建立很多個不同的 並行 loop 在同一個 stream  上</p>
<p>但是有可能會需要更加有彈性的作法</p>
<p>或是需要有一些緩衝區域</p>
<p>再慢慢消耗的數據</p>
<p><a href="https://github.com/SocketCluster/writable-consumable-stream#writable-consumable-stream" target="_blank" rel="noopener">WritableConsumableStream repo</a></p>
<p> 可以參考這個做法</p>
<h2 id="WritableConsumableStream"><a href="#WritableConsumableStream" class="headerlink" title="WritableConsumableStream"></a>WritableConsumableStream</h2><p> <code>for-await-of loop</code> 可以利用 <code>ConsumableStream class</code> </p>
<p> <a href="https://github.com/SocketCluster/consumable-stream" target="_blank" rel="noopener">ConsumableStream class Example</a></p>
<h2 id="可以自定義-socket-consumer"><a href="#可以自定義-socket-consumer" class="headerlink" title="可以自定義 socket consumer"></a>可以自定義 socket consumer</h2> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connectionConsumerA = agServer.listener(<span class="string">'connection'</span>).createConsumer();</span><br><span class="line"><span class="keyword">const</span> connectionConsumerB = agServer.listener(<span class="string">'connection'</span>).createConsumer();</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> &#123;socket&#125; <span class="keyword">of</span> connectionConsumerA) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Consumer <span class="subst">$&#123;connectionConsumerA.id&#125;</span> handled connection: <span class="subst">$&#123;socket.id&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> &#123;socket&#125; <span class="keyword">of</span> connectionConsumerB) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Consumer <span class="subst">$&#123;connectionConsumerB.id&#125;</span> handled connection: <span class="subst">$&#123;socket.id&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Kill only connectionConsumerA.</span></span><br><span class="line">  connectionConsumerA.kill();</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>
<p> 上述範例會建立兩個 stream </p>
<p> 當一個 socket 連上也會同時連上兩個 consumer </p>
<p> 兩個的 <code>socket.id</code> 也會是一致的</p>
<p> 而在一秒後會把 <code>connectionConsumerA</code> 的 socket 關閉</p>
<p> 所以一秒後只會有 <code>connectionConsumerB</code> 可以連上</p>
<p> 這樣可以更加彈性的控制 socket 的連線</p>
<h2 id="可以在執行之前做一些事情"><a href="#可以在執行之前做一些事情" class="headerlink" title="可以在執行之前做一些事情"></a>可以在執行之前做一些事情</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> &#123;socket&#125; <span class="keyword">of</span> agServer.listener(<span class="string">'connection'</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'doSomethingWhichTakesAFewSeconds'</span>, socket.id)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> data <span class="keyword">of</span> socket.receiver(<span class="string">'foo'</span>)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"forawait -&gt; data"</span>, data)</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>在每個連線之前都可以執行一段程式碼</p>
<p>共用邏輯可以放置在這邊</p>
<h3 id="特殊情境"><a href="#特殊情境" class="headerlink" title="特殊情境"></a>特殊情境</h3><p>backend</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sleep = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'doSomethingWhichTakesAFewSeconds'</span>);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> &#123;socket&#125; <span class="keyword">of</span> agServer.listener(<span class="string">'connection'</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">await</span> sleep();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> data <span class="keyword">of</span> socket.receiver(<span class="string">'foo'</span>)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"forawait -&gt; data"</span>, data)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>frondend</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> socket = socketClusterClient.create();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> event <span class="keyword">of</span> socket.listener(<span class="string">'connect'</span>)) &#123;</span><br><span class="line">  socket.transmit(<span class="string">'foo'</span>, <span class="number">123</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述程式碼執行的時候</p>
<p>Backend 會因為 <code>await sleep();</code> 非同步問題</p>
<p><code>socket.receiver(&#39;foo&#39;)</code> 在非同步之後</p>
<p>會無法執行到 <code>console.log(&quot;forawait -&gt; data&quot;, data)</code></p>
<p>所有的情境都會造成訊息的丟失</p>
<p>所以需要做一些調整</p>
<h3 id="調整後"><a href="#調整後" class="headerlink" title="調整後"></a>調整後</h3><p>如果只是調整順序的話並不能解決問題</p>
<p>Backend </p><p style="color: red;">Bad</p><p></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> &#123;socket&#125; <span class="keyword">of</span> agServer.listener(<span class="string">'connection'</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="comment">// This will not work because the iterator is not yet created at this point.</span></span><br><span class="line">      <span class="keyword">let</span> fooStream = socket.receiver(<span class="string">'foo'</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If any messages arrive during this time, they will be ignored!</span></span><br><span class="line">      <span class="keyword">await</span> doSomethingWhichTakesAFewSeconds();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// The iterator gets created (and starts buffering) here!</span></span><br><span class="line">      <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> data <span class="keyword">of</span> fooStream) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>Backend </p><p style="color: green;">Good</p><p></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> &#123;socket&#125; <span class="keyword">of</span> agServer.listener(<span class="string">'connection'</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="comment">// This will create a consumable which will start buffering messages immediately.</span></span><br><span class="line">      <span class="keyword">let</span> fooStreamConsumable = socket.receiver(<span class="string">'foo'</span>).createConsumer();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">await</span> sleep();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// This loop will start from the beginning of the buffer.</span></span><br><span class="line">      <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> data <span class="keyword">of</span> fooStreamConsumable) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"forawait -&gt; data"</span>, data)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>下一個章節再來繼續處理一下 <code>API</code> 相關問題</p>
<h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><p><a href="https://socketcluster.io/docs/consumers/" target="_blank" rel="noopener">Consumer</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Nodejs/">Nodejs</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nodejs/">Nodejs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SocketCluster/">SocketCluster</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Socketcluster-Cluster-initial" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/09/09/Socketcluster-Cluster-initial/" class="article-date">
      <time datetime="2020-09-08T17:05:05.000Z" itemprop="datePublished">2020-09-09</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/09/Socketcluster-Cluster-initial/">SocketCluster Cluster initial.md</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Basic-Install"><a href="#Basic-Install" class="headerlink" title="Basic Install"></a>Basic Install</h1><h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><p><a href="https://github.com/nvm-sh/nvm" target="_blank" rel="noopener">nvm</a></p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$</span> nvm install <span class="number">14.9</span><span class="number">.0</span></span><br><span class="line"><span class="symbol">$</span> nvm use <span class="number">14.9</span><span class="number">.0</span></span><br><span class="line"><span class="symbol">$</span> npm install -g socketcluster@<span class="number">16.0</span><span class="number">.1</span></span><br><span class="line"><span class="symbol">$</span> socketcluster --help</span><br><span class="line"><span class="symbol">$</span> socketcluster create helloworld</span><br><span class="line"><span class="symbol">$</span> cd helloworld</span><br><span class="line"><span class="symbol">$</span> yarn start <span class="comment">// yarn start</span></span><br><span class="line"><span class="symbol">$</span> socketcluster run <span class="comment">// run on docker</span></span><br><span class="line"><span class="symbol">$</span> curl http:<span class="comment">//localhost:8000/health-check // will get OK</span></span><br></pre></td></tr></table></figure>
<p>也可以試著 使用瀏覽器打開 <code>http://localhost:8000/index.html</code></p>
<p>預設會有一個簡單的頁面連線 websocket</p>
<p>初始化之後會有一個基礎的骨架來處理 http request 與 socket connections</p>
<h3 id="HTTP-Request-Handler"><a href="#HTTP-Request-Handler" class="headerlink" title="HTTP Request Handler"></a>HTTP Request Handler</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">;<span class="function">(<span class="params"><span class="keyword">async</span> (</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> requestData <span class="keyword">of</span> httpServer.listener(<span class="string">'request'</span>)) &#123;</span><br><span class="line">    expressApp.apply(<span class="literal">null</span>, requestData)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<p>http 的部分不需要再增加程式碼</p>
<p>可以直接使用</p>
<h3 id="Socket-connections"><a href="#Socket-connections" class="headerlink" title="Socket connections"></a>Socket connections</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">;<span class="function">(<span class="params"><span class="keyword">async</span> (</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> &#123; socket &#125; <span class="keyword">of</span> agServer.listener(<span class="string">'connection'</span>)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'forawait -&gt; socket.id'</span>, socket.id)</span><br><span class="line">    <span class="comment">// Handle socket connection.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<h4 id="Listen-custom-Event-in-socket"><a href="#Listen-custom-Event-in-socket" class="headerlink" title="Listen custom Event in socket"></a>Listen custom Event in socket</h4><h5 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SocketCluster/WebSocket connection handling loop.</span></span><br><span class="line">;<span class="function">(<span class="params"><span class="keyword">async</span> (</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> &#123; socket &#125; <span class="keyword">of</span> agServer.listener(<span class="string">'connection'</span>)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(</span><br><span class="line">      <span class="string">'forawait -&gt; socket.id'</span>,</span><br><span class="line">      socket.id</span><br><span class="line">    )(</span><br><span class="line">      <span class="comment">// Handle socket connection.</span></span><br><span class="line">      <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="comment">// Set up a loop to handle remote transmitted events.</span></span><br><span class="line">        <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> data <span class="keyword">of</span> socket.receiver(<span class="string">'helloworld'</span>)) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.warn(<span class="string">'forawait -&gt; helloworld -&gt; data'</span>, data)</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'forawait -&gt; error.message'</span>, error.message)</span><br><span class="line">          &#125;          </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    )()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<p>可以再加上 <code>try catch</code> 來處理 Error</p>
<h5 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  socket.transmit(<span class="string">'helloworld'</span>, <span class="number">123</span>)</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure>
<h4 id="也可以透過-procedure-回傳一些資訊"><a href="#也可以透過-procedure-回傳一些資訊" class="headerlink" title="也可以透過 procedure 回傳一些資訊"></a>也可以透過 <code>procedure</code> 回傳一些資訊</h4><h5 id="Server-1"><a href="#Server-1" class="headerlink" title="Server"></a>Server</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">;<span class="function">(<span class="params"><span class="keyword">async</span> (</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Set up a loop to handle and respond to RPCs.</span></span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> request <span class="keyword">of</span> socket.procedure(<span class="string">'customProc'</span>)) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (request.data &amp;&amp; request.data.bad) &#123;</span><br><span class="line">        <span class="keyword">let</span> badCustomError = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Server failed to execute the procedure'</span>)</span><br><span class="line">        badCustomError.name = <span class="string">'BadCustomError'</span></span><br><span class="line">        <span class="keyword">throw</span> badCustomError</span><br><span class="line">      &#125;</span><br><span class="line">      request.end(<span class="string">'Success'</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'forawait -&gt; customProc -&gt; error.message'</span>, error.message)</span><br><span class="line">      request.error(error)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<p>也可以利用 <code>request.error(error)</code> 來處理回傳錯誤</p>
<p>Client 也可以利用 <code>try catch</code> 來接收到錯誤</p>
<h2 id="Subscribe-and-Publish"><a href="#Subscribe-and-Publish" class="headerlink" title="Subscribe and Publish"></a>Subscribe and Publish</h2><p>另外也可以建立 <code>channel</code> 來處理 subscribe 與 publish</p>
<p>在 <code>Client</code> 中加上</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> channel = socket.subscribe(<span class="string">'foo'</span>);</span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> data <span class="keyword">of</span> channel) &#123;</span><br><span class="line">    <span class="comment">// ... Handle channel data.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>就可以在開始聽取 <code>foo</code> 的頻道</p>
<p>接受該頻道的訊息</p>
<p>不只是 Server 的訊息會接收</p>
<p>其他 <code>Client</code> 也可以透過這些頻道彼此溝通</p>
<h4 id="Client-1"><a href="#Client-1" class="headerlink" title="Client"></a>Client</h4><p>不需要 acknowledgment 的訊息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket.transmitPublish(<span class="string">'foo'</span>, <span class="string">'This is some data'</span>);</span><br></pre></td></tr></table></figure>
<p>需要 acknowledgment 的訊息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> socket.invokePublish(<span class="string">'foo'</span>, <span class="string">'This is some more data'</span>);</span><br></pre></td></tr></table></figure>
<h4 id="Server-2"><a href="#Server-2" class="headerlink" title="Server"></a>Server</h4><p>不需要 acknowledgment 的訊息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">agServer.exchange.transmitPublish(<span class="string">'foo'</span>, <span class="string">'This is some data'</span>);</span><br></pre></td></tr></table></figure>
<p>需要 acknowledgment 的訊息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> agServer.exchange.invokePublish(<span class="string">'foo'</span>, <span class="string">'This is some more data'</span>);</span><br></pre></td></tr></table></figure>
<p>不管是 <code>Client</code> 或是 <code>Server</code> 如果是需要 acknowledmgment 的訊息<br>需要配合 <code>Consumers</code> 的配合</p>
<h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><p><a href="https://socketcluster.io/docs/basic-usage/" target="_blank" rel="noopener">Basic Usage</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Nodejs/">Nodejs</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nodejs/">Nodejs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SocketCluster/">SocketCluster</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-SocketCluster-Authorization" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/09/09/SocketCluster-Authorization/" class="article-date">
      <time datetime="2020-09-08T17:04:53.000Z" itemprop="datePublished">2020-09-09</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/09/SocketCluster-Authorization/">SocketCluster-Authorization</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Authorization"><a href="#Authorization" class="headerlink" title="Authorization"></a>Authorization</h1><p>在 SocketCluster 預設使用 <code>JWT</code> 處理驗證問題</p>
<p>在AGServer 之中有一個參數 <code>authKey</code> 是一個字串，提供 <code>JWT</code> 的 token 建立與驗證使用</p>
<p><code>Client</code> 也可以使用 <code>socket.authenticate</code></p>
<p>因為可能一個服務或多個服務 同時會有 HTTP 與 Websocket </p>
<p>所以會希望同一個 <code>token</code> 可以在各服務內使用</p>
<p>做使用者的驗證</p>
<h2 id="建立-JWT-Token"><a href="#建立-JWT-Token" class="headerlink" title="建立 JWT Token"></a>建立 JWT Token</h2><h3 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h3><p>最基本的使用方式是透過 <code>Express</code> 來建立 token</p>
<p>然後再將此 token 送到客戶短提供使用</p>
<p>客戶端獲得這個 token 的之後必須要加到 <code>socketcluster.authToken</code> 中</p>
<p>這是 <code>SocketCluster</code> 的預設 <code>JWT</code> localStorage token</p>
<p>建立新連線的時候或是重新連線時 SocketCluster 會自動在 localStorage 取得 <code>JWT</code></p>
<h4 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h4><p>新增一個 Express 的 route</p>
<p>因為是 demo</p>
<p>所以先用 <code>GET</code> 來測試</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">expressApp.get(<span class="string">'/login'</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> myTokenData = &#123;</span><br><span class="line">    username: <span class="string">'bob'</span>,</span><br><span class="line">    language: <span class="string">'English'</span>,</span><br><span class="line">    company: <span class="string">'Google'</span>,</span><br><span class="line">    groups: [<span class="string">'engineering'</span>, <span class="string">'science'</span>, <span class="string">'mathematics'</span>]</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> signedTokenString = <span class="keyword">await</span> agServer.auth.signToken(myTokenData, agServer.signatureKey);</span><br><span class="line"></span><br><span class="line">  res.status(<span class="number">200</span>).json(&#123;</span><br><span class="line">    token: signedTokenString</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>之後在瀏覽器測試可以取得 <code>token</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"token"</span>:<span class="string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImJvYiIsImxhbmd1YWdlIjoiRW5nbGlzaCIsImNvbXBhbnkiOiJHb29nbGUiLCJncm91cHMiOlsiZW5naW5lZXJpbmciLCJzY2llbmNlIiwibWF0aGVtYXRpY3MiXSwiaWF0IjoxNTk5NTczMzA1fQ.TBwhqJlhVlpEwCcqsv9-JT5Vx7Z32D4YpCUebEDZSHQ"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Websocket"><a href="#Websocket" class="headerlink" title="Websocket"></a>Websocket</h4><p>利用 WebSocket 建立 token 的範例</p>
<h5 id="Server-1"><a href="#Server-1" class="headerlink" title="Server"></a>Server</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> request <span class="keyword">of</span> socket.procedure(<span class="string">'login'</span>)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">"forawait -&gt; request.data"</span>, request.data)</span><br><span class="line">          <span class="comment">//chgeck use done</span></span><br><span class="line">  </span><br><span class="line">          </span><br><span class="line">        </span><br><span class="line">          socket.setAuthToken(&#123;<span class="attr">username</span>: request.data.username&#125;);</span><br><span class="line">          request.end();</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(error) &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">"forawait -&gt; error"</span>, error)</span><br><span class="line">          <span class="keyword">let</span> loginError = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`Could not find a <span class="subst">$&#123;request.data.username&#125;</span> user`</span>);</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">"forawait -&gt; loginError"</span>, loginError)</span><br><span class="line">        loginError.name = <span class="string">'LoginError'</span>;</span><br><span class="line">        request.error(loginError);</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">        &#125;        </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)();</span><br></pre></td></tr></table></figure>
<h5 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// Invoke a custom 'login' procedure (RPC) on our server socket</span></span><br><span class="line">         <span class="comment">// then wait for the socket to be authenticated.</span></span><br><span class="line">         <span class="keyword">const</span> [, authResult] = <span class="keyword">await</span> <span class="built_in">Promise</span>.all([</span><br><span class="line">           socket.invoke(<span class="string">"login"</span>, credentials),</span><br><span class="line">           socket.listener(<span class="string">"authenticate"</span>).once(),</span><br><span class="line">         ]);</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">"authResult"</span>, <span class="built_in">JSON</span>.stringify(authResult))</span><br><span class="line">     &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">"error"</span>, error)</span><br><span class="line">       <span class="comment">// showLoginError(err);</span></span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     &#125;)();</span><br></pre></td></tr></table></figure>
<p>Client 可以拿到的 Resonse 是</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"signedAuthToken"</span>: <span class="string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFsaWNlMTIzIiwiaWF0IjoxNTk5NTc2MDkyLCJleHAiOjE1OTk2NjI0OTJ9.fccJ4zBdCqpoXrHW-NWxEK9r5ykMYyA0aokQRZitUmw"</span>,</span><br><span class="line">	<span class="attr">"authToken"</span>: &#123;</span><br><span class="line">		<span class="attr">"username"</span>: <span class="string">"alice123"</span>,</span><br><span class="line">		<span class="attr">"iat"</span>: <span class="number">1599576092</span>,</span><br><span class="line">		<span class="attr">"exp"</span>: <span class="number">1599662492</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="驗證-JWT-Token"><a href="#驗證-JWT-Token" class="headerlink" title="驗證 JWT Token"></a>驗證 JWT Token</h2><p>在 SocketCluster 中不論是 <code>HTTP</code> 和 <code>WebSocket</code> 的驗證方式都是一樣的</p>
<p>但是在這之前要先了解 SocketClsuter 的 Middleware 的使用方式</p>
<h3 id="Middleware"><a href="#Middleware" class="headerlink" title="Middleware"></a>Middleware</h3><p>SocketCluster 中可以註冊 <code>Middleware</code></p>
<p>支援的類別總共四種</p>
<ul>
<li>agServer.MIDDLEWARE_HANDSHAKE    </li>
<li>agServer.MIDDLEWARE_INBOUND_RAW</li>
<li>agServer.MIDDLEWARE_INBOUND<ul>
<li>from client -&gt; server</li>
</ul>
</li>
<li>agServer.MIDDLEWARE_OUTBOUND<ul>
<li>from server -&gt; client</li>
</ul>
</li>
</ul>
<h3 id="註冊-Middleware"><a href="#註冊-Middleware" class="headerlink" title="註冊 Middleware"></a>註冊 Middleware</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">agServer.setMiddleware(agServer.MIDDLEWARE_INBOUND, <span class="keyword">async</span> (middlewareStream) =&gt; &#123;</span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> action <span class="keyword">of</span> middlewareStream) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"forawait -&gt; action.type"</span>, action.type)</span><br><span class="line">    <span class="keyword">if</span> (action.type === action.TRANSMIT) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!action.data) &#123;</span><br><span class="line">        <span class="keyword">let</span> error = <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">          <span class="string">'Transmit action must have a data object'</span></span><br><span class="line">        );</span><br><span class="line">        error.name = <span class="string">'InvalidActionError'</span>;</span><br><span class="line">        action.block(error);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action.type === action.INVOKE) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!action.data) &#123;</span><br><span class="line">        <span class="keyword">let</span> error = <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">          <span class="string">'Invoke action must have a data object'</span></span><br><span class="line">          );</span><br><span class="line">          error.name = <span class="string">'InvalidActionError'</span>;</span><br><span class="line">          action.block(error);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// token 的物件</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"forawait -&gt; action.data"</span>, action.data)</span><br><span class="line">    &#125;</span><br><span class="line">    action.allow();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>利用註冊 <code>IN_BOUIND</code> 與 <code>OUT_BOUND</code> 的註冊 middleware </p>
<p>來達成驗證 <code>JWT</code> token</p>
<h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><p><a href="https://socketcluster.io/docs/authentication/" target="_blank" rel="noopener">Authorization</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Nodejs/">Nodejs</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nodejs/">Nodejs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SocketCluster/">SocketCluster</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ReactNative-ExportComponentUI" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/12/06/ReactNative-ExportComponentUI/" class="article-date">
      <time datetime="2019-12-06T09:13:39.000Z" itemprop="datePublished">2019-12-06</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/06/ReactNative-ExportComponentUI/">React Native-ExportComponentUI</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h1><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">react-<span class="keyword">native</span> <span class="keyword">init</span> CounterApp</span><br><span class="line">cd CounterApp</span><br><span class="line">react-<span class="keyword">native</span> run-ios</span><br></pre></td></tr></table></figure>
<p>App.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  StyleSheet,</span><br><span class="line">  View,</span><br><span class="line">  Text,</span><br><span class="line">  TouchableOpacity,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123; </span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      count: <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  increment = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">count</span>: <span class="keyword">this</span>.state.count + <span class="number">1</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;View style=&#123;styles.container&#125;&gt;</span><br><span class="line">        &lt;TouchableOpacity</span><br><span class="line">          style=&#123;[styles.wrapper, styles.border]&#125;</span><br><span class="line">          onPress=&#123;<span class="keyword">this</span>.increment&#125;</span><br><span class="line">        &gt;</span><br><span class="line">          &lt;Text style=&#123;styles.button&#125;&gt;</span><br><span class="line">            &#123;<span class="keyword">this</span>.state.count&#125;</span><br><span class="line">          &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>TouchableOpacity&gt;</span><br><span class="line">      &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">const styles = StyleSheet.create(&#123;</span></span><br><span class="line"><span class="regexp">  container: &#123;</span></span><br><span class="line"><span class="regexp">    flex: 1, alignItems: "stretch"</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  wrapper: &#123;</span></span><br><span class="line"><span class="regexp">    flex: 1, alignItems: "center", justifyContent: "center"</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  border: &#123;</span></span><br><span class="line"><span class="regexp">    borderColor: "#eee", borderBottomWidth: 1</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  button: &#123;</span></span><br><span class="line"><span class="regexp">    fontSize: 50, color: "orange"</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default App;</span></span><br></pre></td></tr></table></figure>
<h1 id="How-to-expose-a-Swift-UI-Component-to-JS"><a href="#How-to-expose-a-Swift-UI-Component-to-JS" class="headerlink" title="How to expose a Swift UI Component to JS"></a>How to expose a Swift UI Component to JS</h1><h2 id="建立一個-Swift-ViewManager"><a href="#建立一個-Swift-ViewManager" class="headerlink" title="建立一個 Swift ViewManager"></a>建立一個 Swift ViewManager</h2><ul>
<li>File → New → File… (or CMD+N)</li>
<li>Select Swift File</li>
<li>Name your file CounterViewManager</li>
<li>In the Group dropdown, make sure to select the group CounterApp, not the project itself.</li>
</ul>
<p><a href="https://miro.medium.com/max/1514/1*GaIIeNeYbncmKNTMwLs-Dg.png" target="_blank" rel="noopener">!select CounterApp</a></p>
<h3 id="Configure-the-Objective-C-Bridging-Header"><a href="#Configure-the-Objective-C-Bridging-Header" class="headerlink" title="Configure the Objective-C Bridging Header"></a>Configure the Objective-C Bridging Header</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">After you create the Swift file, you should be prompted to choose if you want to configure an Objective-C Bridging Header. Select “Create Bridging Header”.</span><br></pre></td></tr></table></figure>
<p><a href="https://miro.medium.com/max/1214/1*KOH-ocd4sVbgoXvS5j8d2g.png" target="_blank" rel="noopener">configure Objective-C Bridging Header</a></p>
<p>如果您還沒有標題，請立即添加其中兩個標題</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CounterApp-Bridging-Header.h</span></span><br><span class="line"></span><br><span class="line">#<span class="keyword">import</span> <span class="string">"React/RCTBridgeModule.h"</span></span><br><span class="line">#<span class="keyword">import</span> <span class="string">"React/RCTViewManager.h"</span></span><br></pre></td></tr></table></figure>
<p>CounterViewManager.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@objc</span>(<span class="type">CounterViewManager</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterViewManager</span>: <span class="title">RCTViewManager</span> </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">view</span><span class="params">()</span></span> -&gt; <span class="type">UIView!</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> label = <span class="type">UILabel</span>()</span><br><span class="line">    label.text = <span class="string">"Swift Counter"</span></span><br><span class="line">    label.textAlignment = .center</span><br><span class="line">    <span class="keyword">return</span> label</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="新增一個-Obj-C-檔案"><a href="#新增一個-Obj-C-檔案" class="headerlink" title="新增一個 Obj-C 檔案"></a>新增一個 Obj-C 檔案</h2><ul>
<li>File → New → File… (or CMD+N)</li>
<li>Select Objective-C File</li>
<li>Name your file CounterViewManager</li>
</ul>
<p>CounterViewManager.m</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#import &quot;React/RCTViewManager.h&quot;</span><br><span class="line"></span><br><span class="line">@interface RCT_EXTERN_MODULE(CounterViewManager, RCTViewManager)</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<h2 id="Access-your-Component-from-JS"><a href="#Access-your-Component-from-JS" class="headerlink" title="Access your Component from JS"></a>Access your Component from JS</h2><p>現在你可以使用 <code>requireNativeComponent</code> 來使用</p>
<h2 id="建立-swiftUI"><a href="#建立-swiftUI" class="headerlink" title="建立 swiftUI"></a>建立 swiftUI</h2><p>CounterViewManager.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@objc</span>(<span class="type">CounterViewManager</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterViewManager</span>: <span class="title">RCTViewManager</span> </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">requiresMainQueueSetup</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">view</span><span class="params">()</span></span> -&gt; <span class="type">UIView!</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">CounterView</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CounterView.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterView</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">  <span class="meta">@objc</span> <span class="keyword">var</span> <span class="built_in">count</span> = <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">didSet</span> &#123;</span><br><span class="line">      button.setTitle(<span class="type">String</span>(describing: <span class="built_in">count</span>), <span class="keyword">for</span>: .normal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line">    <span class="keyword">self</span>.addSubview(button)</span><br><span class="line">    increment()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">    <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">lazy</span> <span class="keyword">var</span> button: <span class="type">UIButton</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> b = <span class="type">UIButton</span>.<span class="keyword">init</span>(type: <span class="type">UIButton</span>.<span class="type">ButtonType</span>.system)</span><br><span class="line">    b.titleLabel?.font = <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">50</span>)</span><br><span class="line">    b.autoresizingMask = [.flexibleWidth, .flexibleHeight]</span><br><span class="line">    b.addTarget(</span><br><span class="line">      <span class="keyword">self</span>,</span><br><span class="line">      action: #selector(increment),</span><br><span class="line">      <span class="keyword">for</span>: .touchUpInside</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line">  &#125;()</span><br><span class="line">  <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">increment</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="built_in">count</span> += <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="How-to-send-props-to-a-Swift-Component"><a href="#How-to-send-props-to-a-Swift-Component" class="headerlink" title="How to send props to a Swift Component"></a>How to send props to a Swift Component</h2><p>可以透過 <code>RCT_EXPORT_VIEW_PROPERTY</code> 來 export props</p>
<p>在這個範例中 將 <code>count</code> export </p>
<p>CounterViewManager.m</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"React/RCTViewManager.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RCT_EXTERN_MODULE</span>(<span class="title">CounterViewManager</span>, <span class="title">RCTViewManager</span>)</span></span><br><span class="line">  RCT_EXPORT_VIEW_PROPERTY(count, <span class="built_in">NSNumber</span>)</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><code>Important: you have to use Obj-C types for variables exposed to React Native</code></p>
<p>CounterView.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterView</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">   <span class="meta">@objc</span> <span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">NSNumber</span> = <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">didSet</span> &#123;</span><br><span class="line">      button.setTitle(<span class="type">String</span>(describing: <span class="built_in">count</span>), <span class="keyword">for</span>: .normal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line">    <span class="keyword">self</span>.addSubview(button)</span><br><span class="line">    increment()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">    <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">lazy</span> <span class="keyword">var</span> button: <span class="type">UIButton</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> b = <span class="type">UIButton</span>.<span class="keyword">init</span>(type: <span class="type">UIButton</span>.<span class="type">ButtonType</span>.system)</span><br><span class="line">    b.titleLabel?.font = <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">50</span>)</span><br><span class="line">    b.autoresizingMask = [.flexibleWidth, .flexibleHeight]</span><br><span class="line">    b.addTarget(</span><br><span class="line">      <span class="keyword">self</span>,</span><br><span class="line">      action: #selector(increment),</span><br><span class="line">      <span class="keyword">for</span>: .touchUpInside</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line">  &#125;()</span><br><span class="line">  <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">increment</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="built_in">count</span> = <span class="built_in">count</span>.intValue + <span class="number">1</span> <span class="keyword">as</span> <span class="type">NSNumber</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>App.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  StyleSheet,</span><br><span class="line">  View,</span><br><span class="line">  Text,</span><br><span class="line">  TouchableOpacity,</span><br><span class="line">  requireNativeComponent,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> CounterView = requireNativeComponent(<span class="string">"CounterView"</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123; </span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      count: <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  increment = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">count</span>: <span class="keyword">this</span>.state.count + <span class="number">1</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;View style=&#123;styles.container&#125;&gt;</span><br><span class="line">        &lt;TouchableOpacity</span><br><span class="line">          style=&#123;[styles.wrapper, styles.border]&#125;</span><br><span class="line">          onPress=&#123;<span class="keyword">this</span>.increment&#125;</span><br><span class="line">        &gt;</span><br><span class="line">          &lt;Text style=&#123;styles.button&#125;&gt;</span><br><span class="line">            &#123;<span class="keyword">this</span>.state.count&#125;</span><br><span class="line">          &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>TouchableOpacity&gt;</span><br><span class="line"></span><br><span class="line">        &lt;CounterView style=&#123; styles.wrapper &#125; count=&#123;<span class="number">2</span>&#125; /&gt;</span><br><span class="line">      &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">const styles = StyleSheet.create(&#123;</span></span><br><span class="line"><span class="regexp">  container: &#123;</span></span><br><span class="line"><span class="regexp">    flex: 1, alignItems: "stretch"</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  wrapper: &#123;</span></span><br><span class="line"><span class="regexp">    flex: 1, alignItems: "center", justifyContent: "center"</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  border: &#123;</span></span><br><span class="line"><span class="regexp">    borderColor: "#eee", borderBottomWidth: 1</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  button: &#123;</span></span><br><span class="line"><span class="regexp">    fontSize: 50, color: "orange"</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default App;</span></span><br></pre></td></tr></table></figure>
<h2 id="Expose-a-Component-Event-Emitter"><a href="#Expose-a-Component-Event-Emitter" class="headerlink" title="Expose a Component Event Emitter"></a>Expose a Component Event Emitter</h2><p>接下來使用一個 <code>function</code> 來讓 native 使用</p>
<p>CounterView.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterView</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">   <span class="meta">@objc</span> <span class="keyword">var</span> onUpdate: <span class="type">RCTDirectEventBlock?</span></span><br><span class="line">  </span><br><span class="line">   <span class="meta">@objc</span> <span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">NSNumber</span> = <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">didSet</span> &#123;</span><br><span class="line">      button.setTitle(<span class="type">String</span>(describing: <span class="built_in">count</span>), <span class="keyword">for</span>: .normal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line">    <span class="keyword">self</span>.addSubview(button)</span><br><span class="line">    increment()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">    <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">lazy</span> <span class="keyword">var</span> button: <span class="type">UIButton</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> b = <span class="type">UIButton</span>.<span class="keyword">init</span>(type: <span class="type">UIButton</span>.<span class="type">ButtonType</span>.system)</span><br><span class="line">    b.titleLabel?.font = <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">50</span>)</span><br><span class="line">    b.autoresizingMask = [.flexibleWidth, .flexibleHeight]</span><br><span class="line">    b.addTarget(</span><br><span class="line">      <span class="keyword">self</span>,</span><br><span class="line">      action: #selector(increment),</span><br><span class="line">      <span class="keyword">for</span>: .touchUpInside</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> longPress = <span class="type">UILongPressGestureRecognizer</span>(</span><br><span class="line">      target: <span class="keyword">self</span>,</span><br><span class="line">      action: #selector(sendUpdate(<span class="number">_</span>:))</span><br><span class="line">    )</span><br><span class="line">    b.addGestureRecognizer(longPress)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line">  &#125;()</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">sendUpdate</span><span class="params">(<span class="number">_</span> gesture: UILongPressGestureRecognizer)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> gesture.state == .began &#123;</span><br><span class="line">      <span class="keyword">if</span> onUpdate != <span class="literal">nil</span> &#123;</span><br><span class="line">        onUpdate!([<span class="string">"count"</span>: <span class="built_in">count</span>])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">increment</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="built_in">count</span> = <span class="built_in">count</span>.intValue + <span class="number">1</span> <span class="keyword">as</span> <span class="type">NSNumber</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If you have to send any data to a RCTDirectEventBlock method, you must return a [AnyHashable:Any] structure. This means that you can’t pass a String or Int directly, you have to put them in a Dictionary.</p>
<p>CounterViewManager.m</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"React/RCTViewManager.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RCT_EXTERN_MODULE</span>(<span class="title">CounterViewManager</span>, <span class="title">RCTViewManager</span>)</span></span><br><span class="line">  RCT_EXPORT_VIEW_PROPERTY(count, <span class="built_in">NSNumber</span>)</span><br><span class="line">  RCT_EXPORT_VIEW_PROPERTY(onUpdate, RCTDirectEventBlock)</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>在 header 也要增加一行</p>
<h2 id="Expose-methods-on-the-ViewManager"><a href="#Expose-methods-on-the-ViewManager" class="headerlink" title="Expose methods on the ViewManager"></a>Expose methods on the ViewManager</h2><p>CounterApp-Bridging-Header.h</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">import</span> <span class="string">"React/RCTBridgeModule.h"</span></span><br><span class="line">#<span class="keyword">import</span> <span class="string">"React/RCTViewManager.h"</span></span><br><span class="line">#<span class="keyword">import</span> <span class="string">"React/RCTEventEmitter.h"</span></span><br><span class="line">#<span class="keyword">import</span> <span class="string">"React/RCTUIManager.h"</span></span><br></pre></td></tr></table></figure>
<p>CounterViewManager.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@objc</span>(<span class="type">CounterViewManager</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterViewManager</span>: <span class="title">RCTViewManager</span> </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">requiresMainQueueSetup</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">view</span><span class="params">()</span></span> -&gt; <span class="type">UIView!</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">CounterView</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">updateFromManager</span><span class="params">(<span class="number">_</span> node: NSNumber, <span class="built_in">count</span>: NSNumber)</span></span> &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="type">DispatchQueue</span>.main.async &#123;                                <span class="comment">// 2</span></span><br><span class="line">        <span class="keyword">let</span> component = <span class="keyword">self</span>.bridge.uiManager.view(             <span class="comment">// 3</span></span><br><span class="line">          forReactTag: node                                     <span class="comment">// 4</span></span><br><span class="line">        ) <span class="keyword">as</span>! <span class="type">CounterView</span>                                       <span class="comment">// 5</span></span><br><span class="line">        component.update(value: <span class="built_in">count</span>)                          <span class="comment">// 6</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CounterView.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterView</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">   <span class="meta">@objc</span> <span class="keyword">var</span> onUpdate: <span class="type">RCTDirectEventBlock?</span></span><br><span class="line">  </span><br><span class="line">   <span class="meta">@objc</span> <span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">NSNumber</span> = <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">didSet</span> &#123;</span><br><span class="line">      button.setTitle(<span class="type">String</span>(describing: <span class="built_in">count</span>), <span class="keyword">for</span>: .normal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line">    <span class="keyword">self</span>.addSubview(button)</span><br><span class="line">    increment()</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">requiresMainQueueSetup</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">    <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">lazy</span> <span class="keyword">var</span> button: <span class="type">UIButton</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> b = <span class="type">UIButton</span>.<span class="keyword">init</span>(type: <span class="type">UIButton</span>.<span class="type">ButtonType</span>.system)</span><br><span class="line">    b.titleLabel?.font = <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">50</span>)</span><br><span class="line">    b.autoresizingMask = [.flexibleWidth, .flexibleHeight]</span><br><span class="line">    b.addTarget(</span><br><span class="line">      <span class="keyword">self</span>,</span><br><span class="line">      action: #selector(increment),</span><br><span class="line">      <span class="keyword">for</span>: .touchUpInside</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> longPress = <span class="type">UILongPressGestureRecognizer</span>(</span><br><span class="line">      target: <span class="keyword">self</span>,</span><br><span class="line">      action: #selector(sendUpdate(<span class="number">_</span>:))</span><br><span class="line">    )</span><br><span class="line">    b.addGestureRecognizer(longPress)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line">  &#125;()</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">update</span><span class="params">(value: NSNumber)</span></span> &#123;</span><br><span class="line">      <span class="built_in">count</span> = value</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">sendUpdate</span><span class="params">(<span class="number">_</span> gesture: UILongPressGestureRecognizer)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> gesture.state == .began &#123;</span><br><span class="line">      <span class="keyword">if</span> onUpdate != <span class="literal">nil</span> &#123;</span><br><span class="line">        onUpdate!([<span class="string">"count"</span>: <span class="built_in">count</span>])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">increment</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="built_in">count</span> = <span class="built_in">count</span>.intValue + <span class="number">1</span> <span class="keyword">as</span> <span class="type">NSNumber</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>App.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sample React Native App</span></span><br><span class="line"><span class="comment"> * https://github.com/facebook/react-native</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@format</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@flow</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  StyleSheet,</span><br><span class="line">  View,</span><br><span class="line">  Text,</span><br><span class="line">  UIManager,</span><br><span class="line">  TouchableOpacity,</span><br><span class="line">  requireNativeComponent,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> CounterView = requireNativeComponent(<span class="string">"CounterView"</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123; </span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      count: <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  increment = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">count</span>: <span class="keyword">this</span>.state.count + <span class="number">1</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  update = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      count: e.nativeEvent.count</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _onUpdate = <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.onUpdate) &#123;</span><br><span class="line">      <span class="keyword">this</span>.props.onUpdate(event.nativeEvent);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  updateNative = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    UIManager.dispatchViewManagerCommand(</span><br><span class="line">      findNodeHandle(<span class="keyword">this</span>.counterRef),                     <span class="comment">// 1</span></span><br><span class="line">      UIManager[<span class="string">"CounterView"</span>].Commands.updateFromManager, <span class="comment">// 2</span></span><br><span class="line">      [<span class="keyword">this</span>.state.count]                                   <span class="comment">// 3</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;View style=&#123;styles.container&#125;&gt;</span><br><span class="line">        &lt;TouchableOpacity</span><br><span class="line">          style=&#123;[styles.wrapper, styles.border]&#125;</span><br><span class="line">          onPress=&#123;<span class="keyword">this</span>.increment&#125;</span><br><span class="line">        &gt;</span><br><span class="line">          &lt;Text style=&#123;styles.button&#125;&gt;</span><br><span class="line">            &#123;<span class="keyword">this</span>.state.count&#125;</span><br><span class="line">          &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>TouchableOpacity&gt;</span><br><span class="line"></span><br><span class="line">        &lt;CounterView</span><br><span class="line">          style=&#123; styles.wrapper &#125;</span><br><span class="line">          count=&#123;<span class="keyword">this</span>.state.count&#125;</span><br><span class="line">          onUpdate=&#123;<span class="keyword">this</span>._onUpdate&#125;</span><br><span class="line">          ref=&#123;ref =&gt; <span class="keyword">this</span>.ref = ref&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">const styles = StyleSheet.create(&#123;</span></span><br><span class="line"><span class="regexp">  container: &#123;</span></span><br><span class="line"><span class="regexp">    flex: 1, alignItems: "stretch"</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  wrapper: &#123;</span></span><br><span class="line"><span class="regexp">    flex: 1, alignItems: "center", justifyContent: "center"</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  border: &#123;</span></span><br><span class="line"><span class="regexp">    borderColor: "#eee", borderBottomWidth: 1</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  button: &#123;</span></span><br><span class="line"><span class="regexp">    fontSize: 50, color: "orange"</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default App;</span></span><br></pre></td></tr></table></figure>
<h1 id="參考文章"><a href="#參考文章" class="headerlink" title="參考文章"></a>參考文章</h1><p><a href="https://teabreak.e-spres-oh.com/swift-in-react-native-the-ultimate-guide-part-2-ui-components-907767123d9e#2389" target="_blank" rel="noopener">Swift in React Native</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/React-Native/">React Native</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React-Native/">React Native</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Moleculer-Start" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/06/04/Moleculer-Start/" class="article-date">
      <time datetime="2019-06-04T07:35:51.000Z" itemprop="datePublished">2019-06-04</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/04/Moleculer-Start/">Moleculer-Start</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h1><h2 id="Create-your-first-microservice"><a href="#Create-your-first-microservice" class="headerlink" title="Create your first microservice"></a>Create your first microservice</h2><p><strong>demo.js</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; ServiceBroker &#125; = <span class="built_in">require</span>(<span class="string">"moleculer"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> broker = <span class="keyword">new</span> ServiceBroker();</span><br><span class="line"></span><br><span class="line">broker.createService(&#123;</span><br><span class="line">    name: <span class="string">"math"</span>,</span><br><span class="line">    actions: &#123;</span><br><span class="line">        add(ctx) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Number</span>(ctx.params.a) + <span class="built_in">Number</span>(ctx.params.b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">broker.start()</span><br><span class="line">    <span class="comment">// Call service</span></span><br><span class="line">    .then(<span class="function"><span class="params">()</span> =&gt;</span> broker.call(<span class="string">"math.add"</span>, &#123; <span class="attr">a</span>: <span class="number">5</span>, <span class="attr">b</span>: <span class="number">3</span> &#125;))</span><br><span class="line">    .then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"5 + 3 ="</span>, res))</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.error(<span class="string">`Error occured! <span class="subst">$&#123;err.message&#125;</span>`</span>));</span><br></pre></td></tr></table></figure></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[2019-06-03T07:54:26.366Z] <span class="builtin-name">INFO</span>  ********/BROKER: Moleculer v0.13.9 is starting<span class="built_in">..</span>.</span><br><span class="line">[2019-06-03T07:54:26.369Z] <span class="builtin-name">INFO</span>  ********/BROKER: Node ID: ********</span><br><span class="line">[2019-06-03T07:54:26.370Z] <span class="builtin-name">INFO</span>  ********/BROKER: Namespace: &lt;<span class="keyword">not</span> defined&gt;</span><br><span class="line">[2019-06-03T07:54:26.370Z] <span class="builtin-name">INFO</span>  ********/REGISTRY: Strategy: RoundRobinStrategy</span><br><span class="line">[2019-06-03T07:54:26.372Z] <span class="builtin-name">INFO</span>  ********/BROKER: Serializer: JSONSerializer</span><br><span class="line">[2019-06-03T07:54:26.373Z] <span class="builtin-name">INFO</span>  ********/BROKER: Registered 10 internal middleware(s).</span><br><span class="line">[2019-06-03T07:54:26.390Z] <span class="builtin-name">INFO</span>  ********/REGISTRY: <span class="string">'$node'</span><span class="built_in"> service </span>is registered.</span><br><span class="line">[2019-06-03T07:54:26.392Z] <span class="builtin-name">INFO</span>  ********/REGISTRY: <span class="string">'math'</span><span class="built_in"> service </span>is registered.</span><br><span class="line">[2019-06-03T07:54:26.394Z] <span class="builtin-name">INFO</span>  ********/BROKER: ServiceBroker with 2 service(s) is started successfully.</span><br><span class="line">5 + 3 = 8</span><br><span class="line">[2019-06-03T07:54:26.400Z] <span class="builtin-name">INFO</span>  ********/BROKER: ServiceBroker is stopped. Good bye.</span><br></pre></td></tr></table></figure>
<p>看到上方範例會啟用一個 microservice </p>
<p>計算出 5 + 3 = 8</p>
<p>之後結束這個程式</p>
<h2 id="Create-a-Moleculer-project"><a href="#Create-a-Moleculer-project" class="headerlink" title="Create a Moleculer project"></a>Create a Moleculer project</h2><h3 id="Install-Nats"><a href="#Install-Nats" class="headerlink" title="Install Nats"></a>Install Nats</h3><p>需要先安裝 Nats </p>
<p>如果您是選擇其他的 <code>transporters</code> 也需要安裝其他的套件</p>
<p>目前有提供的</p>
<ul>
<li>Nats - 推薦使用</li>
<li>MQTT</li>
<li>Redis</li>
<li>NATS streaming (試驗)</li>
<li>Kafka (試驗)</li>
</ul>
<h4 id="Mac"><a href="#Mac" class="headerlink" title="Mac"></a>Mac</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">brew </span><span class="keyword">install </span>gnatsd</span><br></pre></td></tr></table></figure>
<h4 id="Go"><a href="#Go" class="headerlink" title="Go"></a>Go</h4><h3 id="Initial-Project"><a href="#Initial-Project" class="headerlink" title="Initial Project"></a>Initial Project</h3><p>有提供一個 <a href="https://moleculer.services/docs/0.13/moleculer-cli.html" target="_blank" rel="noopener">Cli tool</a></p>
<p>install moleculer-cli</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i moleculer-<span class="keyword">cli</span> -g</span><br></pre></td></tr></table></figure>
<p>create a new project</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ moleculer init <span class="keyword">project</span> moleculer-demo</span><br></pre></td></tr></table></figure>
<p>client 會提供幾個選項讓你選擇</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">? <span class="keyword">Add</span> API Gateway (moleculer-web) service? <span class="comment">// 是否使用 api gateway</span></span><br><span class="line">? Would you like <span class="keyword">to</span> communicate <span class="keyword">with</span> other nodes? <span class="comment">// 是否需要和其他 nodes 溝通</span></span><br><span class="line">? <span class="keyword">Select</span> a transporter NATS (recommended) <span class="comment">// 使用哪一種 transporter 工具</span></span><br><span class="line">? Would you like <span class="keyword">to</span> use cache?  是否要使用 cache</span><br><span class="line">? <span class="keyword">Select</span> a cacher solution </span><br><span class="line">? <span class="keyword">Add</span> Docker files? 是否要使用 Docker</span><br><span class="line">? Use ESLint <span class="keyword">to</span> lint your code? 是否使用 ESLint</span><br><span class="line">? Setup <span class="keyword">unit</span> tests <span class="keyword">with</span> Jest? Unitest framework</span><br><span class="line"><span class="keyword">Create</span> <span class="string">'moleculerdemo'</span> folder...</span><br><span class="line">? Would you like <span class="keyword">to</span> run <span class="string">'npm install'</span>?</span><br></pre></td></tr></table></figure>
<p>可以依據個人的需求選擇</p>
<p>然後就可以得到一個專案</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── <span class="selector-tag">README</span><span class="selector-class">.md</span></span><br><span class="line">├── <span class="selector-tag">moleculer</span><span class="selector-class">.config</span><span class="selector-class">.js</span></span><br><span class="line">├── <span class="selector-tag">package-lock</span><span class="selector-class">.json</span></span><br><span class="line">├── <span class="selector-tag">package</span><span class="selector-class">.json</span></span><br><span class="line">├── <span class="selector-tag">public</span></span><br><span class="line">│   ├── <span class="selector-tag">banner</span><span class="selector-class">.png</span></span><br><span class="line">│   ├── <span class="selector-tag">favicon</span><span class="selector-class">.ico</span></span><br><span class="line">│   └── <span class="selector-tag">index</span><span class="selector-class">.html</span></span><br><span class="line">├── <span class="selector-tag">services</span></span><br><span class="line">│   ├── <span class="selector-tag">api</span><span class="selector-class">.service</span><span class="selector-class">.js</span></span><br><span class="line">│   └── <span class="selector-tag">greeter</span><span class="selector-class">.service</span><span class="selector-class">.js</span></span><br><span class="line">└── <span class="selector-tag">test</span></span><br><span class="line">    └── <span class="selector-tag">unit</span></span><br><span class="line">        └── <span class="selector-tag">greeter</span><span class="selector-class">.spec</span><span class="selector-class">.js</span></span><br></pre></td></tr></table></figure>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$</span> yarn dev <span class="comment">// 啟動一個 service</span></span><br></pre></td></tr></table></figure>
<h2 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h2><p><code>ServiceBroker</code> 是 <code>Moleculer</code> 中主要的 component </p>
<p>他會處理幾件 <code>nodes</code> 之間溝通的事情</p>
<ul>
<li>actions</li>
<li>emits</li>
<li>events</li>
<li>communicates</li>
</ul>
<p><img src="https://moleculer.services/docs/0.13/broker.html#Broker-options" alt="Broker Options"></p>
<h3 id="Ping"><a href="#Ping" class="headerlink" title="Ping"></a>Ping</h3><p>對遠端的 nodes 使用 <code>broker.ping</code> 來確認遠端 nodes 的狀態</p>
<p>回傳值是一個 <code>Promise</code></p>
<h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><p>ping 一個 node 並設定 1S 的 timeout</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">broker.ping(<span class="string">"node-123"</span>, <span class="number">1000</span>).then(<span class="function"><span class="params">res</span> =&gt;</span> broker.logger.info(res));</span><br></pre></td></tr></table></figure>
<p>output<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    <span class="attribute">nodeID</span>: <span class="string">'node-123'</span>, </span><br><span class="line">    elapsedTime: <span class="number">16</span>, </span><br><span class="line">    timeDiff: -<span class="number">3</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">timeDiff</span> 是兩個節點之間系統時間的誤差值</span><br></pre></td></tr></table></figure>
<p>也可以同時 ping 多個 nodes</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">broker.ping([<span class="string">"node-100"</span>, <span class="string">"node-102"</span>]).then(<span class="function"><span class="params">res</span> =&gt;</span> broker.logger.info(res));</span><br></pre></td></tr></table></figure>
<p>output<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;</span> </span><br><span class="line">    <span class="attr">"node-100":</span> <span class="string">&#123;</span> </span><br><span class="line">        <span class="attr">nodeID:</span> <span class="string">'node-100'</span><span class="string">,</span> </span><br><span class="line">        <span class="attr">elapsedTime:</span> <span class="number">10</span><span class="string">,</span> </span><br><span class="line">        <span class="attr">timeDiff:</span> <span class="number">-2</span> </span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line">    <span class="attr">"node-102":</span> <span class="string">&#123;</span> </span><br><span class="line">        <span class="attr">nodeID:</span> <span class="string">'node-102'</span><span class="string">,</span> </span><br><span class="line">        <span class="attr">elapsedTime:</span> <span class="number">250</span><span class="string">,</span> </span><br><span class="line">        <span class="attr">timeDiff:</span> <span class="number">850</span> </span><br><span class="line">    <span class="string">&#125;</span> </span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>ping 所有的 nodes<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">broker.ping().then(<span class="function"><span class="params">res</span> =&gt;</span> broker.logger.info(res));</span><br></pre></td></tr></table></figure></p>
<p>output<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">&#123;</span> </span><br><span class="line">    <span class="attr">"node-100":</span> <span class="string">&#123;</span> </span><br><span class="line">        <span class="attr">nodeID:</span> <span class="string">'node-100'</span><span class="string">,</span> </span><br><span class="line">        <span class="attr">elapsedTime:</span> <span class="number">10</span><span class="string">,</span> </span><br><span class="line">        <span class="attr">timeDiff:</span> <span class="number">-2</span> </span><br><span class="line">    <span class="string">&#125;</span> <span class="string">,</span></span><br><span class="line">    <span class="attr">"node-101":</span> <span class="string">&#123;</span> </span><br><span class="line">        <span class="attr">nodeID:</span> <span class="string">'node-101'</span><span class="string">,</span> </span><br><span class="line">        <span class="attr">elapsedTime:</span> <span class="number">18</span><span class="string">,</span> </span><br><span class="line">        <span class="attr">timeDiff:</span> <span class="number">32</span> </span><br><span class="line">    <span class="string">&#125;,</span> </span><br><span class="line">    <span class="attr">"node-102":</span> <span class="string">&#123;</span> </span><br><span class="line">        <span class="attr">nodeID:</span> <span class="string">'node-102'</span><span class="string">,</span> </span><br><span class="line">        <span class="attr">elapsedTime:</span> <span class="number">250</span><span class="string">,</span> </span><br><span class="line">        <span class="attr">timeDiff:</span> <span class="number">850</span> </span><br><span class="line">    <span class="string">&#125;</span> </span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p><a href="https://moleculer.services/docs/0.13/broker.html#Properties" target="_blank" rel="noopener">broker properties</a></p>
<p><a href="https://moleculer.services/docs/0.13/broker.html#Methods" target="_blank" rel="noopener">broker methods</a></p>
<h2 id="Services"><a href="#Services" class="headerlink" title="Services"></a>Services</h2><p><code>Services</code> 代表 <code>Moleculer</code> 中的微服務</p>
<p>可以定義多個 <code>action</code> 並且訂閱 ‘event’</p>
<p>建立新的 service 必須先定義好 <code>schema</code></p>
<p>這些 schema 類似 <a href="https://vuejs.org/v2/guide/components.html" target="_blank" rel="noopener">component of Vuejs</a></p>
<ul>
<li>name</li>
<li>version</li>
<li>settings</li>
<li>methods</li>
<li>events</li>
</ul>
<h3 id="Actions"><a href="#Actions" class="headerlink" title="Actions"></a>Actions</h3><p>基本的 <code>schema</code></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attribute">name</span>: <span class="string">"posts"</span>,</span><br><span class="line">    version: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定義多個 <code>actions</code></p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    name: <span class="string">"math"</span>,</span><br><span class="line">    actions: &#123;</span><br><span class="line">        add(<span class="name">ctx</span>) &#123;</span><br><span class="line">            return Number(<span class="name">ctx.params.a</span>) + Number(<span class="name">ctx.params.b</span>)<span class="comment">;</span></span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        sub(<span class="name">ctx</span>) &#123;</span><br><span class="line">            return Number(<span class="name">ctx.params.a</span>) - Number(<span class="name">ctx.params.b</span>)<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>name</code> 是必須要定義的參數</p>
<p>當你呼叫這個 <code>api</code> 時，是第一部分的 route 組成元素</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可以在設定中 disable service name prefix</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  $noServiceNamePrefix: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>version 不是必要的參數</p>
<p>可以讓同樣的 <code>service</code> 跑不同的 version 做 api 版本控制</p>
<p>可以是 <code>Number</code> 和 <code>String</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    name: <span class="string">"posts"</span>,</span><br><span class="line">    version: <span class="number">2</span>,</span><br><span class="line">    actions: &#123;</span><br><span class="line">        find() &#123;...&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上方的範例中若是要呼叫這隻 API route 為 <code>GET /v2/posts/find</code></p>
<h3 id="Settings"><a href="#Settings" class="headerlink" title="Settings"></a>Settings</h3><p>settings 是一個 store</p>
<p>你可以在裡面做各種設定</p>
<p>使用 <code>this.settings</code> 取得你的 setting object</p>
<p><a href="https://moleculer.services/docs/0.13/services.html#Internal-settings" target="_blank" rel="noopener">setting options</a></p>
<h3 id="Mixins"><a href="#Mixins" class="headerlink" title="Mixins"></a>Mixins</h3><p>Mixins 是一個可以在 <code>Moleculer</code> 中可以重複使用的 function</p>
<p>Service 的 constructor 會自動合併這些 mixins</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">const ApiGwService = require(<span class="string">"moleculer-web"</span>);</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line"><span class="symbol">    name:</span> <span class="string">"api"</span>,</span><br><span class="line"><span class="symbol">    mixins:</span> [ApiGwService]</span><br><span class="line"><span class="symbol">    settings:</span> &#123;</span><br><span class="line">        <span class="comment">// Change port setting</span></span><br><span class="line"><span class="symbol">        port:</span> <span class="number">8080</span></span><br><span class="line">    &#125;,</span><br><span class="line"><span class="symbol">    actions:</span> &#123;</span><br><span class="line">        myAction() &#123;</span><br><span class="line">            <span class="comment">// Add a new action to apiGwService service</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://moleculer.services/docs/0.13/services.html#Merge-algorithm" target="_blank" rel="noopener">合併的規則</a></p>
<h3 id="Lifecycle-events"><a href="#Lifecycle-events" class="headerlink" title="Lifecycle events"></a>Lifecycle events</h3><p>當 service 生命週期各自會 trigger 的 function</p>
<ul>
<li>startd</li>
<li>stopped</li>
<li>created</li>
</ul>
<h3 id="Dependencies"><a href="#Dependencies" class="headerlink" title="Dependencies"></a>Dependencies</h3><p>當你的 service 有依賴到其他 service 的時候</p>
<p>可以利用 Dependencies 來做處理(待捕)</p>
<h3 id="Hot-reloading-services"><a href="#Hot-reloading-services" class="headerlink" title="Hot reloading services"></a>Hot reloading services</h3><p>在開發過程中需要使用 hot reloading 的機制有兩種方式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> broker = <span class="keyword">new</span> ServiceBroker(&#123;</span><br><span class="line">    hotReload: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">broker.loadService(<span class="string">"./services/test.service.js"</span>);</span><br></pre></td></tr></table></figure>
<p>或是 command</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ moleculer-runner --hot ./services/test.service.js</span><br></pre></td></tr></table></figure>
<h3 id="Local-variables"><a href="#Local-variables" class="headerlink" title="Local variables"></a>Local variables</h3><p>如果你需要一些 Local variables</p>
<p>可以在 <code>created</code> 中宣告</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    name: <span class="string">"www"</span>,</span><br><span class="line"></span><br><span class="line">    settings: &#123;</span><br><span class="line">        port: <span class="number">3000</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    created() &#123;</span><br><span class="line">        <span class="comment">// Create HTTP server</span></span><br><span class="line">        <span class="keyword">this</span>.server = http.createServer(<span class="keyword">this</span>.httpHandler);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    started() &#123;</span><br><span class="line">        <span class="comment">// Listening...</span></span><br><span class="line">        <span class="keyword">this</span>.server.listen(<span class="keyword">this</span>.settings.port);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    stopped() &#123;</span><br><span class="line">        <span class="comment">// Stop server</span></span><br><span class="line">        <span class="keyword">this</span>.server.close();</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    methods() &#123;</span><br><span class="line">        <span class="comment">// HTTP handler</span></span><br><span class="line">        httpHandler(req, res) &#123;</span><br><span class="line">            res.end(<span class="string">"Hello Moleculer!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ES6-classses"><a href="#ES6-classses" class="headerlink" title="ES6 classses"></a>ES6 classses</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Service = <span class="built_in">require</span>(<span class="string">"moleculer"</span>).Service;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GreeterService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(broker) &#123;</span><br><span class="line">        <span class="keyword">super</span>(broker);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.parseServiceSchema(&#123;</span><br><span class="line">            name: <span class="string">"greeter"</span>,</span><br><span class="line">            version: <span class="string">"v2"</span>,</span><br><span class="line">            meta: &#123;</span><br><span class="line">                scalable: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            dependencies: [</span><br><span class="line">                <span class="string">"auth"</span>,</span><br><span class="line">                <span class="string">"users"</span></span><br><span class="line">            ],</span><br><span class="line"></span><br><span class="line">            settings: &#123;</span><br><span class="line">                upperCase: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            actions: &#123;</span><br><span class="line">                hello: <span class="keyword">this</span>.hello,</span><br><span class="line">                welcome: &#123;</span><br><span class="line">                    cache: &#123;</span><br><span class="line">                        keys: [<span class="string">"name"</span>]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    params: &#123;</span><br><span class="line">                        name: <span class="string">"string"</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    handler: <span class="keyword">this</span>.welcome</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            events: &#123;</span><br><span class="line">                <span class="string">"user.created"</span>: <span class="keyword">this</span>.userCreated</span><br><span class="line">            &#125;,</span><br><span class="line">            created: <span class="keyword">this</span>.serviceCreated,</span><br><span class="line">            started: <span class="keyword">this</span>.serviceStarted,</span><br><span class="line">            stopped: <span class="keyword">this</span>.serviceStopped,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Action handler</span></span><br><span class="line">    hello() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello Moleculer"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Action handler</span></span><br><span class="line">    welcome(ctx) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.sayWelcome(ctx.params.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Private method</span></span><br><span class="line">    sayWelcome(name) &#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.info(<span class="string">"Say hello to"</span>, name);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`Welcome, <span class="subst">$&#123;<span class="keyword">this</span>.settings.upperCase ? name.toUpperCase() : name&#125;</span>`</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Event handler</span></span><br><span class="line">    userCreated(user) &#123;</span><br><span class="line">        <span class="keyword">this</span>.broker.call(<span class="string">"mail.send"</span>, &#123; user &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serviceCreated() &#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.info(<span class="string">"ES6 Service created."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serviceStarted() &#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.info(<span class="string">"ES6 Service started."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serviceStopped() &#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.info(<span class="string">"ES6 Service stopped."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = GreeterService;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Nodejs/">Nodejs</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Microservies/">Microservies</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nodejs/">Nodejs</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-RN-Platform" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/02/24/RN-Platform/" class="article-date">
      <time datetime="2019-02-24T15:44:45.000Z" itemprop="datePublished">2019-02-24</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/24/RN-Platform/">React Native-Platform</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Platform"><a href="#Platform" class="headerlink" title="Platform"></a>Platform</h1><h2 id="Platform-Specific-Code"><a href="#Platform-Specific-Code" class="headerlink" title="Platform Specific Code"></a>Platform Specific Code</h2><p>在初期的時候可以利用檔案模式來做整合</p>
<p>可以將檔案名稱命名為 <code>.ios.js</code> 和 <code>.android.js</code></p>
<p>然後在不同的平台上 require 不同的檔案</p>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">BigButton</span><span class="selector-class">.ios</span><span class="selector-class">.js</span></span><br><span class="line"><span class="selector-tag">BigButton</span><span class="selector-class">.android</span><span class="selector-class">.js</span></span><br></pre></td></tr></table></figure>
<p>然後就可以在你想要的地方 import 檔案</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> BigButton <span class="keyword">from</span> <span class="string">'./BigButton'</span>;</span><br></pre></td></tr></table></figure>
<p>因為 <code>React Native</code> 是跨平台的 Framework</p>
<p>畢竟 IOS Android 之間還是有相當的不同之處</p>
<p>可以利用 <code>Platform</code> 這個模組來統一的整理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Platform, StyleSheet&#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = StyleSheet.create(&#123;</span><br><span class="line">  height: Platform.OS === <span class="string">'ios'</span> ? <span class="number">200</span> : <span class="number">100</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>Platform</code> module 會依據平台來執行相對應的程式碼</p>
<p>如果是 <code>ios</code> 的話 height 是 200</p>
<p>如果是 <code>android</code> 的話 height 是 100</p>
<p>另外也有 <code>Platform.select</code> 可以使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Platform, StyleSheet&#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = StyleSheet.create(&#123;</span><br><span class="line">  container: &#123;</span><br><span class="line">    flex: <span class="number">1</span>,</span><br><span class="line">    ...Platform.select(&#123;</span><br><span class="line">      ios: &#123;</span><br><span class="line">        backgroundColor: <span class="string">'red'</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      android: &#123;</span><br><span class="line">        backgroundColor: <span class="string">'blue'</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>上述程式碼中使用到 <code>container</code> Style 的都會有 <code>flex: 1</code> 的參數</p>
<p>但是在 <code>ios</code> 中會是紅色</p>
<p>在 <code>android</code> 中會是藍色的背 景色</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StyleSheet, Text, View, Platform &#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SpecificPlatformComponent = Platform.select(&#123;</span><br><span class="line">  ios: <span class="function"><span class="params">()</span> =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">Text</span>&gt;</span>I am use IOS<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span>,</span><br><span class="line">  android: <span class="function"><span class="params">()</span> =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">Text</span>&gt;</span>I am use Android<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;View style=&#123;styles.container&#125;&gt;</span><br><span class="line">        &lt;Text&gt;Open up App.js to start working on your app!&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">        &lt;SpecificPlatformComponent /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const styles = StyleSheet.create(&#123;</span></span><br><span class="line"><span class="regexp">  container: &#123;</span></span><br><span class="line"><span class="regexp">    flex: 1,</span></span><br><span class="line"><span class="regexp">    backgroundColor: '#fff',</span></span><br><span class="line"><span class="regexp">    alignItems: 'center',</span></span><br><span class="line"><span class="regexp">    justifyContent: 'center',</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br></pre></td></tr></table></figure>
<p>或是像是這樣也可以依據不同的平台引用 component</p>
<h2 id="OS-Version"><a href="#OS-Version" class="headerlink" title="OS Version"></a>OS Version</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StyleSheet, Text, View, Platform &#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SpecificPlatformComponent = Platform.select(&#123;</span><br><span class="line">  ios: <span class="function"><span class="params">()</span> =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">Text</span>&gt;</span>I am use IOS<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span>,</span><br><span class="line">  android: <span class="function"><span class="params">()</span> =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">Text</span>&gt;</span>I am use Android<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SpecificPlatformVersionComponent = Platform.select(&#123;</span><br><span class="line">  ios: <span class="function"><span class="params">()</span> =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">Text</span>&gt;</span>my Iphone Version is &#123;Platform.Version&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span>,</span><br><span class="line">  android: <span class="function"><span class="params">()</span> =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">Text</span>&gt;</span>my Android Version is &#123;Platform.Version&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;View style=&#123;styles.container&#125;&gt;</span><br><span class="line">        &lt;Text&gt;Open up App.js to start working on your app!&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">        &lt;SpecificPlatformComponent /</span>&gt;</span><br><span class="line">        &lt;SpecificPlatformVersionComponent /&gt;</span><br><span class="line">      &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const styles = StyleSheet.create(&#123;</span></span><br><span class="line"><span class="regexp">  container: &#123;</span></span><br><span class="line"><span class="regexp">    flex: 1,</span></span><br><span class="line"><span class="regexp">    backgroundColor: '#fff',</span></span><br><span class="line"><span class="regexp">    alignItems: 'center',</span></span><br><span class="line"><span class="regexp">    justifyContent: 'center',</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/React-Native/">React Native</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React-Native/">React Native</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Truffle-pet-user-interface" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/02/07/Truffle-pet-user-interface/" class="article-date">
      <time datetime="2019-02-07T14:55:11.000Z" itemprop="datePublished">2019-02-07</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/07/Truffle-pet-user-interface/">Truffle-pet-user-interface</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Truffle-pet-demo"><a href="#Truffle-pet-demo" class="headerlink" title="Truffle pet demo"></a>Truffle pet demo</h1><p><a href="https://horsekitlin.github.io/2018/05/05/Truffle-pet-demo/">延續</a></p>
<h1 id="建立一個前端介面"><a href="#建立一個前端介面" class="headerlink" title="建立一個前端介面"></a>建立一個前端介面</h1><p>上一篇初始化的程式中也包含了前端的程式碼</p>
<p>但是只有一部分</p>
<p>需要做一些補全 </p>
<ol>
<li>打開 <code>/src/js/app.js</code></li>
<li>app.js 裡面已經有 一個物件叫做 <code>App</code> 控制我們的前端<ol>
<li><code>init()</code> 負責 load data</li>
<li><code>initWeb3()</code> <a href="https://github.com/ethereum/web3.js/" target="_blank" rel="noopener">web3 lib</a>他可以取回使用者帳號的資訊，發送交易需求</li>
<li>移除 <code>initWeb3()</code> 中的註解 加上下面這段程式碼</li>
</ol>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">initWeb3: <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">window</span>.ethereum) &#123;</span><br><span class="line">      App.web3Provider = <span class="built_in">window</span>.ethereum;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="built_in">window</span>.ethereum.enable();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">"User denied account access"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">window</span>.web3) &#123;</span><br><span class="line">      App.web3Provider = <span class="built_in">window</span>.web3.currentProvider;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      App.web3Provider = <span class="keyword">new</span> Web3.providers.HttpProvider(<span class="string">'http://localhost:7545'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    web3 = <span class="keyword">new</span> Web3(App.web3Provider);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> App.initContract();</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<ul>
<li>先檢查瀏覽器中是否有 <code>ethereum</code> provider 如果有的話就建立自己的 <code>web3</code> 物件來取得帳號資訊，但是依舊要呼叫 <code>ethereum.enable()</code></li>
<li>如果 <code>ethereum</code> 不存在，檢查 <code>window.web3</code> 是否存在來引用舊版的 provider</li>
<li>如果沒有的話就是測試使用 <code>localhost:7545</code></li>
</ul>
<h2 id="Instantiating-the-contract"><a href="#Instantiating-the-contract" class="headerlink" title="Instantiating the contract"></a>Instantiating the contract</h2><p>處理好 <code>web3</code> 的初始化之後</p>
<p>現在需要來解決一下如何實際在前端取得合約的資料</p>
<p><code>truffle</code> 有一個 lib 可以協助處理這件事情: <code>truffle-contract</code></p>
<p>他會在 有新的 <code>migrations</code> 同步合約上的資訊</p>
<p>所以你不用修改合約的位址</p>
<ol>
<li><code>/src/js/app.js</code> 中有 <code>initContract</code> 的函式</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">initContract: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  $.getJSON(<span class="string">'Adoption.json'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> AdoptionArtifact = data;</span><br><span class="line">    App.contracts.Adoption = TruffleContract(AdoptionArtifact);</span><br><span class="line"></span><br><span class="line">    App.contracts.Adoption.setProvider(App.web3Provider);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> App.markAdopted();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> App.bindEvents();</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<ul>
<li>先檢索在鏈上的合約文件，<code>AdoptionArtifact</code> 是合約的內容資訊，包含位址 DApp 接口(ABI)</li>
<li>一但我們取得 Artifact 會將他 pass 給 <code>TruffleContract()</code>. 他會產生一個新的物件，這個物件會提供一下 method 讓我們可以跟合約溝通</li>
<li>產生的 實例會設定給 <code>App.web3Provider</code> 以方便 web3使用</li>
<li>然後呼叫 APP 的 <code>markAdopted()</code> function 封裝這個是因為方便在合約改變的時候可以同時改變 UI</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Note: ABI: Application Binary<span class="built_in"> Interface </span>應用程式機器碼介面</span><br><span class="line">ABI 是一個 Javascript 對象，用來定義如何跟合約相互溝通的接口</span><br></pre></td></tr></table></figure>
<h2 id="Getting-The-Adopted-Pets-and-Updating-The-UI"><a href="#Getting-The-Adopted-Pets-and-Updating-The-UI" class="headerlink" title="Getting The Adopted Pets and Updating The UI"></a>Getting The Adopted Pets and Updating The UI</h2><p>在 <code>/src/js/app.js</code> 中移除 <code>markAdopted</code> 中的註解並填入下述程式碼</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">markAdopted: <span class="function"><span class="keyword">function</span>(<span class="params">adopters, account</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> adoptionInstance;</span><br><span class="line"></span><br><span class="line">  App.contracts.Adoption.deployed().then(<span class="function"><span class="keyword">function</span>(<span class="params">instance</span>) </span>&#123;</span><br><span class="line">    adoptionInstance = instance;</span><br><span class="line">    <span class="keyword">return</span> adoptionInstance.call();</span><br><span class="line">  &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">adopters</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;adopters.length; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span>(adopters[i] !== <span class="string">'0x0000000000000000000000000000000000000000'</span>) &#123;</span><br><span class="line">        $(<span class="string">'.panel-pet'</span>).eq(i).find(<span class="string">'button'</span>).text(<span class="string">'Success'</span>).attr(<span class="string">'disabled'</span>, <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error.message)</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>這一段程式碼中闡述了</p>
<ul>
<li>同意部署 <code>Adoption</code> 合約，然後呼叫 <code>getAdopters()</code> 在這個實例中</li>
<li>因為宣告了<code>adoptionInstance</code> 在最外面，所以在之後可以呼叫他</li>
<li><code>call()</code> 可以讓我們讀取資料而不用發送一個交易，代表我們不用花費任何乙太幣</li>
<li>呼叫 <code>getAdopters()</code> 使用一個迴圈訪問所有的 <code>pet</code> 確定是否已經有了位址，因為以太使用 16 個位元的初始值，而不是用 <code>null</code> </li>
<li>如果找到有相對應位址的就禁用按鈕並將按鈕的文字改為 <code>成功</code> 以便使用者了解這些資訊</li>
<li>所有的錯誤都會顯示在 <code>console</code></li>
</ul>
<h2 id="Handling-the-adopt-Function"><a href="#Handling-the-adopt-Function" class="headerlink" title="Handling the adopt() Function"></a>Handling the adopt() Function</h2><p>依舊是在 <code>/src/js/app.js</code> 中，移除 <code>handleAdopt</code> 函式中的註解，替換為下列程式碼</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">handleAdopt: <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  event.preventDefault();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> petId = <span class="built_in">parseInt</span>($(event.target).data(<span class="string">'id'</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> adoptionInstance;</span><br><span class="line"></span><br><span class="line">  web3.eth.getAccounts(<span class="function"><span class="keyword">function</span>(<span class="params">error, accounts</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(error) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> account = accounts[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    App.contracts.Adoption.deployed()</span><br><span class="line">      .then(<span class="function"><span class="keyword">function</span>(<span class="params">instance</span>) </span>&#123;</span><br><span class="line">        adoptionInstance = instance;</span><br><span class="line">        <span class="keyword">return</span> adoptionInstance.adopt(petId, &#123;<span class="attr">from</span>: account&#125;);</span><br><span class="line">      &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> App.markAdopted();</span><br><span class="line">      &#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error.message);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>利用 <code>web3</code> 取得使用者帳號列，含有 <code>error</code> 檢查是否錯誤，若無誤 取第一個帳號</li>
<li>在這裡已經取得部署成功的合約，將它 指定給 <code>adoptionInstance</code> 這個變數，這一次我們會發送一個交易請求而且必須要有 <code>from</code> 這個位址，這個動作會產生一些費用，在乙太中 這個費用叫做 <code>gas</code>，這是一種手續費用，在你儲存或是計算的時候需要付出部分 <code>gas</code> <code>adopt()</code> 中含有 寵物的 ID 和一個物件，這些資訊會被儲存在 <code>account</code>中</li>
<li>發送交易後的結果是一個物件，如果沒有錯誤的話會呼叫 <code>markAdopted()</code> 來同步 UI 和儲存的資訊</li>
</ul>
<p>最簡單的方式是透過 <a href="https://metamask.io/" target="_blank" rel="noopener">MetaMask</a> 這個在 chrome 和 firefox 都有相關的擴充套件</p>
<ol>
<li>安裝 MetaMask</li>
<li><img src="https://truffleframework.com/img/tutorials/pet-shop/metamask-privacy.png" alt></li>
<li>點擊同意</li>
<li><img src="https://truffleframework.com/img/tutorials/pet-shop/metamask-terms.png" alt="閱讀如何使用"></li>
<li><img src="https://truffleframework.com/img/tutorials/pet-shop/metamask-initial.png" alt="輸入密碼"></li>
<li><img src="https://truffleframework.com/img/tutorials/pet-shop/metamask-networkmenu.png" alt="完成"></li>
<li>在 MetaMask 中選擇 <code>New RPC URL</code> 並且輸入 <code>http://127.0.0.1:7545</code></li>
</ol>
<h2 id="Installing-and-configuring-lite-server"><a href="#Installing-and-configuring-lite-server" class="headerlink" title="Installing and configuring lite-server"></a>Installing and configuring lite-server</h2><p>可以起一個 local 的 service 來看看結果</p>
<ol>
<li>編輯 <code>bs-config.json</code> 改為下述程式碼</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"server"</span>: &#123;</span><br><span class="line">    <span class="attr">"baseDir"</span>: [<span class="string">"./src"</span>, <span class="string">"./build/contracts"</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm <span class="keyword">run</span><span class="bash"> dev</span></span><br></pre></td></tr></table></figure>
<h1 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h1><p><img src="../../../../images/blockchain/example.png" alt="Image"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Block-Chain/">Block Chain</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Sodility/">Sodility</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Truffle/">Truffle</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2024 Tomas Lin
            </div>
            <!-- <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div> -->
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>